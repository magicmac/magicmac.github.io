<!DOCTYPE html><html lang="en"> <head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><link rel="alternate icon" type="image/x-icon" href="/favicon.ico"><meta name="generator" content="Astro v5.16.6"><title>SOP bypass / UXSS - Adventures in a Domainless World (Edge)</title><meta name="description" content><link rel="canonical" href="https://www.brokenbrowser.com/blog/uxss-edge-domainless-world/"><meta property="og:title" content="SOP bypass / UXSS - Adventures in a Domainless World (Edge)"><meta property="og:description" content><meta property="og:type" content="website"><meta property="og:url" content="https://www.brokenbrowser.com/blog/uxss-edge-domainless-world/"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:title" content="SOP bypass / UXSS - Adventures in a Domainless World (Edge)"><meta name="twitter:description" content><link rel="sitemap" href="/sitemap-index.xml"><link rel="alternate" type="application/rss+xml" title="RSS" href="/rss.xml"><link rel="stylesheet" href="/_astro/_slug_.D8CnJWvD.css"></head> <body> <div class="container center"> <header class="header"> <div class="header__inner"> <div class="header__logo"> <a href="/"> <div class="logo">
MagicMac Labs
</div> </a> </div> <ul class="menu menu--mobile"> <li class="menu__trigger">Menu ▾</li> <li> <ul class="menu__dropdown"> <!--<li><a href={`${base}`}>Home</a></li>--> <li><a href="/browser-workshop/">Browser Workshop</a></li> <li><a href="/musings/">Musings</a></li> <li><a href="/about/">About</a></li> </ul> </li> </ul> </div> <nav class="navigation-menu"> <ul class="navigation-menu__inner menu--desktop"> <!--<li><a href={`${base}`}>Home</a></li>--> <li><a href="/browser-workshop/">Browser Workshop</a></li> <li><a href="/musings/">Musings</a></li> <li><a href="/about/">About</a></li> </ul> </nav> </header> <main class="content">  <article> <h1 class="post-title">SOP bypass / UXSS - Adventures in a Domainless World (Edge)</h1> <div class="post-meta"> <time> <time datetime="2016-12-13T00:00:00.000Z"> 2016-12-13 </time> </time> <span class="post-category"> :: browser-workshop</span>  </div>  <div class="post-content">  <p>Today we are going to walk around a few design issues that, when used together, will end up in a <strong>full SOP bypass</strong> or <strong>Universal Cross Site Scripting</strong> (UXSS) on Microsoft Edge. If you are not a security researcher but you still want to understand this vulnerability, think about it this way: visiting a malicious webpage an attacker will be able to read the cookies of your fav sites, change the content on the fly (on the client), sometimes even get personal information like saved usernames/passwords. Also, because Microsoft Edge uses protected <a href="../spoof-addressbar-malware/">internal resources</a> to do special things, an attacker can potentially access those resources and probably set Edge configuration flags, open IE, etc.</p>
<p>Here we have <a href="https://www.youtube.com/watch?v=I-tVxMXgTiQ">a video exposing bing cookies</a> and <a href="https://www.youtube.com/watch?v=5hcOvBvB1JE">another video showing the content of nature.com</a>. But keep in mind that those sites have no problems at all: the vulnerability is exclusively from Microsoft Edge browser. Let’s see how it’s done!</p>
<h2 id="domainless-world">Domainless World</h2>
<p>The about:blank is a very special URL that sometimes gets confused and it does not know where it belongs to. Think about it: if we are in <code>www.magicmac.com/dom/index.html</code> the document.domain is obviously <code>www.magicmac.com</code>, but what would be the domain of about:blank? It depends. In theory it should match the domain of its referrer, the webpage that set its URL. For example, if we are in <code>www.magicmac.com</code> and we click on an <code>about:blank</code> link, then, this particular about:blank will have <code>www.magicmac.com</code> as its domain.</p>
<p><img src="/images/2016/12/01-about-blank-page.png" alt=""></p>
<p>Another example could be an iframe with its source pointing to about:blank explicitly, or without a source at all (the browser defaults it to about:blank).</p>
<p><img src="/images/2016/12/02-about-blank-iframe.png" alt="">
So, an about:blank loaded from goodfellas.com looks similar to one from evil.com because both URLs are the same, but they have a different document.domain so <strong>they cannot access each other</strong>.</p>
<p>But let me ask you a question: what would be the domain of an about:blank that we’ve manually typed into the address bar? Got you! The answer is important, so I’ll zoom-in DevTools a bit.</p>
<p><img src="/images/2016/12/03-about-blank-domainless.png" alt=""></p>
<p>It’s empty and it has a tremendous power as we will see in a bit, but just to be sure we are on the same page, let’s call URLs without a domain “domainless” and “domained” to the ones that have a document.domain.</p>
<p>Bug hunter, what follows is the most important thing you will read in this post.</p>
<h3 id="a-domainless-aboutblank-is-capable-of-accessing-any-domained-aboutblank"><em>A domainless about:blank is capable of accessing any domained about:blank</em></h3>
<p>In other words, a domainless about:blank can access a domained about:blank without restrictions. Let’s cheat here for a moment and quickly add a bing.com iframe into this page, straight from the debug console.</p>
<pre class="astro-code css-variables" style="background-color:var(--astro-code-background);color:var(--astro-code-foreground); overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="html"><code><span class="line"><span style="color:var(--astro-code-foreground)">document.body.innerHTML = '&#x3C;</span><span style="color:var(--astro-code-token-string-expression)">iframe</span><span style="color:var(--astro-code-token-function)"> src</span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-token-string-expression)">"http://www.bing.com/images/search?q=microsoft+edge"</span><span style="color:var(--astro-code-foreground)">>&#x3C;/</span><span style="color:var(--astro-code-token-string-expression)">iframe</span><span style="color:var(--astro-code-foreground)">>'</span></span></code></pre>
<p><img src="/images/2016/12/04-injected-bing-devtools.png" alt=""></p>
<p>Great! We have now a framed bing.com inside a top domainless blank, but our goal is to find a blank iframe inside bing because as we said, a domainless blank (main window here) will be able to access any domained blank (a blank iframe inside bing.com)</p>
<p>In this case it will be easy because we are using bing.com already has blank iframes. But let’s get the taste of it anyway! Even from the debugger, the next instruction would normally return an access denied, but because the top is domainless, it will work. Let see!</p>
<pre class="astro-code css-variables" style="background-color:var(--astro-code-background);color:var(--astro-code-foreground); overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="javascript"><code><span class="line"><span style="color:var(--astro-code-foreground)">window[</span><span style="color:var(--astro-code-token-constant)">0</span><span style="color:var(--astro-code-foreground)">][</span><span style="color:var(--astro-code-token-constant)">0</span><span style="color:var(--astro-code-foreground)">].</span><span style="color:var(--astro-code-token-constant)">location</span><span style="color:var(--astro-code-foreground)">.href </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-token-string-expression)"> "javascript:alert(parent.document.domain)"</span><span style="color:var(--astro-code-foreground)">;</span></span></code></pre>
<p><img src="/images/2016/12/05-injectscript-bing.png" alt=""></p>
<p>Bang! I know this is not impressing you because we are working from DevTools, right? But for me, it’s the most important thing that we’ve done because if we grasp this concept, then, finding new UXSSs will be <em>to some extent</em>, easy. From now on, every time we find a way to access a domainless blank (generally about:blank, but we can use others as well), we will have a UXSS. We are working with DevTools because I want to make sure that we completely understand what we are doing, but of course we don’t need it!</p>
<h2 id="stand-alone-pocno-devtools-required">Stand-Alone PoC. No DevTools Required</h2>
<p>Let’s do it for real now. We need to find a way to create a domainless site accessible from a regular webpage, and the quicker way to do it is with a data: URI instead of an about:blank. Same thing, just a different protocol. However, if we load a data: uri inside an iframe, its domain will be the same as its referrer domain (just as we’ve seen at the beginning with the about:blank),  and if we attempt to load a data: uri on top, Edge will refuse sending us to an error page.</p>
<p>However, there are several tricks that we can do to get our domainless data: uri, and today we are going to explore the Flash version because it is extremely simple. In fact, I’ve been using this flash since 2005 without changes, it only sets a URL from its query-string. Grab it an use it!</p>
<pre class="astro-code css-variables" style="background-color:var(--astro-code-background);color:var(--astro-code-foreground); overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="html"><code><span class="line"><span style="color:var(--astro-code-foreground)">&#x3C;</span><span style="color:var(--astro-code-token-string-expression)">iframe</span><span style="color:var(--astro-code-token-function)"> src</span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-token-string-expression)">"geturl.swf?target=_top&#x26;redir=data:,[html/script goes here]"</span><span style="color:var(--astro-code-foreground)">>&#x3C;/</span><span style="color:var(--astro-code-token-string-expression)">iframe</span><span style="color:var(--astro-code-foreground)">></span></span></code></pre>
<p>See? Just add the URL you want to load in the <strong>redir</strong> param and it’s done. In this case we are using a data: uri which ends up being loaded in the top, domainless. Also, to fool Edge we need to load the swf inside an iframe, otherwise it won’t work (error page). Try it and see for yourself!</p>
<p>By the way, don’t forget that we can find alternatives to achieve the same thing. We just happen to use this because it’s the first that we found, and Adobe guys will probably blacklist the data: uri <a href="../on-patching-security-bugs/">helping my friends @Edge to get rid of this bug</a>. However, there are many ways to achieve the same thing without the flash file. Make the idea yours, and find your way!</p>
<p>OK, now that we are in a domainless window we can inject an iframe pointing to bing.com, but Edge is in a state that doesn’t render elements correctly. If we try to use createElement/insertAdjacentHtml/etc it will fail. I mean, Edge will draw a dead iframe just like a car without an engine: it simply does not work. To overcome this problem we will document.write ourselves, forcing the browser to render everything again. And because we are in a domainless URL, the document.write will keep us exactly in the same location/domain.</p>
<pre class="astro-code css-variables" style="background-color:var(--astro-code-background);color:var(--astro-code-foreground); overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="javascript"><code><span class="line"><span style="color:var(--astro-code-token-constant)">document</span><span style="color:var(--astro-code-token-function)">.write</span><span style="color:var(--astro-code-foreground)">(</span><span style="color:var(--astro-code-token-string-expression)">'&#x3C;iframe src="http://www.bing.com/images">&#x3C;/iframe>'</span><span style="color:var(--astro-code-foreground)">);</span></span></code></pre>
<p>Perfect! Now we can access bing’s blank iframe, but remember we’ve been lucky because not all sites will have “free blank iframes” inside.</p>
<pre class="astro-code css-variables" style="background-color:var(--astro-code-background);color:var(--astro-code-foreground); overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="javascript"><code><span class="line"><span style="color:var(--astro-code-foreground)">window[</span><span style="color:var(--astro-code-token-constant)">0</span><span style="color:var(--astro-code-foreground)">][</span><span style="color:var(--astro-code-token-constant)">0</span><span style="color:var(--astro-code-foreground)">].</span><span style="color:var(--astro-code-token-constant)">location</span><span style="color:var(--astro-code-foreground)">.href </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-token-string-expression)"> "javascript:alert(parent.document.cookie)"</span><span style="color:var(--astro-code-foreground)">;</span></span></code></pre>
<p><img src="/images/2016/12/06-bing-easy.png" alt=""></p>
<p>Update: Patched - CVE-2017-0002</p>
<p>I’m getting excited, this is working without DevTools! Oh no, I know what you are thinking now, skeptic bug hunter: Bing is serving us a couple of blank iframes in a silver platter, so this was easy! And you are right, but I was just celebrating a bit! From now on I will call you killjoy! No more “bug hunter”. :)</p>
<p>Let’s continue, killjoy. I know that sites won’t like the idea of placing blank iframes for us, so we need to find our way.</p>
<h2 id="owning-non-cooperative-sites">Owning non-cooperative sites</h2>
<p>Imagine that we are in the second step where the top is a domainless data: and our iframe is correctly rendered but pointing to nature.com instead of bing.com (because nature has a non-blank iframe inside). If we try to change the location of that iframe Edge will refuse and open a new window instead. In other words, doing something like this won’t help.</p>
<pre class="astro-code css-variables" style="background-color:var(--astro-code-background);color:var(--astro-code-foreground); overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="javascript"><code><span class="line"><span style="color:var(--astro-code-token-comment)">// We are inside a domainless data: so Edge will open a new</span></span>
<span class="line"><span style="color:var(--astro-code-token-comment)">// window instead of changing nature-iframe's location</span></span>
<span class="line"><span style="color:var(--astro-code-foreground)">window[</span><span style="color:var(--astro-code-token-constant)">0</span><span style="color:var(--astro-code-foreground)">][</span><span style="color:var(--astro-code-token-constant)">0</span><span style="color:var(--astro-code-foreground)">].</span><span style="color:var(--astro-code-token-constant)">location</span><span style="color:var(--astro-code-foreground)">.href </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-token-string-expression)"> "about:blank"</span><span style="color:var(--astro-code-foreground)">;</span></span></code></pre>
<p>That won’t work. Maybe it can be bypassed but I haven’t tried enough. It’s a problem that happens in this domainless situation, so, we can just open a new window with a real URL and work from there. This is exactly what we will do:</p>
<ol>
<li>Open a new window with a framed nature.com inside.
[ NOW WE ARE INSIDE THE NEW WINDOW WITH A REGULAR URL ]</li>
<li>Change nature’s inner-iframe location to about:blank so we can give it a name. Yes, we want the iframe to have a name.</li>
<li>Set a name to the about:blank iframe so our domainless opener can access it via window.open. Don’t forget that we are right now inside a window with a regular URL, it’s our opener who has the power. We will name this iframe just like this: window.name = “DAVID_COPPERFIELD” honoring the magician who continues learning and working with passion.</li>
<li>Now we should change the location of the about:blank (which belongs to our domain) to the one of nature. To do it, we will change the location using a meta-refresh to about:blank. Easy. That trick makes sure the about:blank recovers the domain of its parent.</li>
<li>Let the opener know that everything’s ready so it can access, just like this: window.open(“javascript:alert(document.domain)”, “DAVID_COPPERFIELD”);</li>
</ol>
<p><img src="/images/2016/12/07-nature-hard.png" alt=""></p>
<p>Update: Patched - CVE-2017-0002</p>
<p>Enjoy again, but this time jumping and screaming around the house. Yes! Yes! Oopss, my wife is asking me what I found now. She knows what those screams mean. ;)</p>
<p>Mr killjoy, we made it again. The PoCs are interactive so we can learn in real time what we are doing, but please, go over them and read the specific details of the code. I’m sure there’s room for improvement, and if you make these ideas yours it’s highly likely that you will find variations to achieve similar things and more. Research, study, learn! It’s fun.</p>
<p>Can you find your own way to set a domainless URL without a Flash? Yes you can. Also, just with the code that we explored together here, we can create other UXSS scenarios like being inside an iframe that accesses its top. Is that possible? Let’s say we are a banner-ad inside an iframe rendered by Facebook. Is it possible to access our top, and get -for example- the list of a user’s friends? Of course! What about accessing XFO sites that don’t like to be framed? Is the iframe the only element capable of rendering HTML? Last, what about sites that <strong>do not</strong> have iframes at all? I give you my word, we can even access those ones twisting this code a bit. Sit down and explore! <a href="https://goo.gl/a1cvXI">Here you have the required files</a>.</p>
<p>Have a nice day!</p>
<p><a href="https://twitter.com/magicmac2000">Manuel</a></p> <div class="pagination"> <div class="pagination__title"> <span class="pagination__title-h">Read other posts</span> <hr> </div> <div class="pagination__buttons">  <a href="/blog/spoof-addressbar-malware/" class="button inline prev">
&lt; [Spoofing the address bar and the SmartScreen/Malware Warning (Edge)]
</a> <span>::</span> <a href="/blog/uxss-ie-htmlfile/" class="button inline next">
[SOP bypass / UXSS htmlFile in IFrame (IE)] &gt;
</a> </div> </div>  </div> </article> <script type="module">document.addEventListener("DOMContentLoaded",()=>{document.querySelectorAll("pre.astro-code").forEach(t=>{const n=document.createElement("div");n.className="highlight",t.parentNode?.insertBefore(n,t),n.appendChild(t);const a=t.getAttribute("data-language")||"text",o=document.createElement("div");if(o.className="code-title",o.textContent=a,navigator.clipboard){const e=document.createElement("button");e.className="copy-button",e.textContent="Copy",e.addEventListener("click",async()=>{const c=t.textContent||"";try{await navigator.clipboard.writeText(c),e.textContent="Copied",setTimeout(()=>{e.textContent="Copy"},1e3)}catch(r){console.error("Failed to copy:",r)}}),o.appendChild(e)}n.insertBefore(o,t)})});</script>  <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>  </main> <footer class="footer"> <div class="footer__inner"> <div class="copyright"> <span>© 2026 MagicMac Labs</span> </div> </div> </footer> </div> <script type="module">(()=>{const s=document.querySelector(".container"),o=document.querySelectorAll(".menu");document.body.addEventListener("click",()=>{o.forEach(e=>{e.classList.contains("open")&&e.classList.remove("open")})}),window.addEventListener("resize",()=>{o.forEach(e=>{e.classList.remove("open")})}),o.forEach(e=>{const i=e.querySelector(".menu__trigger"),t=e.querySelector(".menu__dropdown");i&&t&&(i.addEventListener("click",n=>{n.stopPropagation(),e.classList.contains("open")?e.classList.remove("open"):(o.forEach(c=>c.classList.remove("open")),e.classList.add("open")),s&&t.getBoundingClientRect().right>s.getBoundingClientRect().right&&(t.style.left="auto",t.style.right="0")}),t.addEventListener("click",n=>n.stopPropagation()))})})();</script> </body> </html> 