<!DOCTYPE html><html lang="en"> <head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><link rel="alternate icon" type="image/x-icon" href="/favicon.ico"><meta name="generator" content="Astro v5.16.6"><title>Workers SOP Bypass importScripts and baseHref (Edge/IE)</title><meta name="description" content><link rel="canonical" href="https://www.brokenbrowser.com/blog/workers-sop-bypass-importscripts-and-basehref/"><meta property="og:title" content="Workers SOP Bypass importScripts and baseHref (Edge/IE)"><meta property="og:description" content><meta property="og:type" content="website"><meta property="og:url" content="https://www.brokenbrowser.com/blog/workers-sop-bypass-importscripts-and-basehref/"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:title" content="Workers SOP Bypass importScripts and baseHref (Edge/IE)"><meta name="twitter:description" content><link rel="sitemap" href="/sitemap-index.xml"><link rel="alternate" type="application/rss+xml" title="RSS" href="/rss.xml"><link rel="stylesheet" href="/_astro/_slug_.D8CnJWvD.css"></head> <body> <div class="container center"> <header class="header"> <div class="header__inner"> <div class="header__logo"> <a href="/"> <div class="logo">
MagicMac Labs
</div> </a> </div> <ul class="menu menu--mobile"> <li class="menu__trigger">Menu ▾</li> <li> <ul class="menu__dropdown"> <!--<li><a href={`${base}`}>Home</a></li>--> <li><a href="/browser-workshop/">Browser Workshop</a></li> <li><a href="/musings/">Musings</a></li> <li><a href="/about/">About</a></li> </ul> </li> </ul> </div> <nav class="navigation-menu"> <ul class="navigation-menu__inner menu--desktop"> <!--<li><a href={`${base}`}>Home</a></li>--> <li><a href="/browser-workshop/">Browser Workshop</a></li> <li><a href="/musings/">Musings</a></li> <li><a href="/about/">About</a></li> </ul> </nav> </header> <main class="content">  <article> <h1 class="post-title">Workers SOP Bypass importScripts and baseHref (Edge/IE)</h1> <div class="post-meta"> <time> <time datetime="2016-09-27T00:00:00.000Z"> 2016-09-27 </time> </time> <span class="post-category"> :: browser-workshop</span>  </div>  <div class="post-content">  <p>As we know, all browsers impose several restrictions when trying to access resources from different origins. Of course we can play music and render images coming from different domains but thanks to the <a href="https://developer.mozilla.org/en-US/docs/Web/Security/Same-origin_policy">Same Origin Policy</a>, we will not be able to read the content of those resources. For example, we can draw an image on a canvas but can’t read its pixels using getImageData unless it is hosted on the same domain as main html.</p>
<p>The same rule applies to scripts. We can freely load external scripts across different domains, but if there’s an error in those scripts we will not be able get any details about it because the error itself could be leaking information. In other words, browsers try to avoid resource information leaking at all costs, even by suppressing error details.</p>
<p>Let’s say we have a page on cracking.com.ar that renders a script from brokenbrowser.com, just like this:</p>
<pre class="astro-code css-variables" style="background-color:var(--astro-code-background);color:var(--astro-code-foreground); overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="html"><code><span class="line"><span style="color:var(--astro-code-foreground)">---- Main page on cracking.com.ar ----</span></span>
<span class="line"><span style="color:var(--astro-code-foreground)">&#x3C;</span><span style="color:var(--astro-code-token-string-expression)">script</span><span style="color:var(--astro-code-token-function)"> src</span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-token-string-expression)">"http://brokenbrowser.com/errorscript.js"</span><span style="color:var(--astro-code-foreground)">>&#x3C;/</span><span style="color:var(--astro-code-token-string-expression)">script</span><span style="color:var(--astro-code-foreground)">></span></span></code></pre>
<pre class="astro-code css-variables" style="background-color:var(--astro-code-background);color:var(--astro-code-foreground); overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="javascript"><code><span class="line"><span style="color:var(--astro-code-token-comment)">//---- Script errorscript.js hosted in brokenbrower.com ----</span></span>
<span class="line"><span style="color:var(--astro-code-token-function)">this_is_an_error</span><span style="color:var(--astro-code-foreground)">();</span></span></code></pre>
<p>The browser will throw an error when trying to execute the non-existent function “<strong>this_is_an_error()</strong>”, however, because the script is coming from a different origin no details are shared with the main thread. In fact, the main page will get a shallow “Script error” message omitting the important information that an error normally carries: <em>description, URL, and line number</em>. The only information that the main page gets is that an error exists, no more than that.</p>
<p>This behavior is correct and protects end users from sites that may disclose important information (like IDs, search terms, etc) in their scripts or other file types.</p>
<pre class="astro-code css-variables" style="background-color:var(--astro-code-background);color:var(--astro-code-foreground); overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="javascript"><code><span class="line"><span style="color:var(--astro-code-foreground)">Script requested from a different origin</span><span style="color:var(--astro-code-token-punctuation)">:</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-foreground)">Description</span><span style="color:var(--astro-code-token-punctuation)">:</span><span style="color:var(--astro-code-foreground)"> Script error</span></span>
<span class="line"><span style="color:var(--astro-code-foreground)">URL</span><span style="color:var(--astro-code-token-punctuation)">:</span></span>
<span class="line"><span style="color:var(--astro-code-foreground)">Line</span><span style="color:var(--astro-code-token-punctuation)">:</span><span style="color:var(--astro-code-token-constant)"> 0</span></span></code></pre>
<p>On the other hand, if we host <strong>errorscript.js</strong> in the same domain where the main page is running, we will happily get more information. Watch the difference:</p>
<pre class="astro-code css-variables" style="background-color:var(--astro-code-background);color:var(--astro-code-foreground); overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="javascript"><code><span class="line"><span style="color:var(--astro-code-foreground)">Script requested from the same origin</span><span style="color:var(--astro-code-token-punctuation)">:</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-foreground)">Description</span><span style="color:var(--astro-code-token-punctuation)">:</span><span style="color:var(--astro-code-token-string-expression)"> 'this_is_an_error'</span><span style="color:var(--astro-code-foreground)"> is </span><span style="color:var(--astro-code-token-constant)">undefined</span></span>
<span class="line"><span style="color:var(--astro-code-foreground)">URL</span><span style="color:var(--astro-code-token-punctuation)">:</span><span style="color:var(--astro-code-foreground)"> http</span><span style="color:var(--astro-code-token-punctuation)">:</span><span style="color:var(--astro-code-token-comment)">//www.cracking.com.ar/errorscript.js</span></span>
<span class="line"><span style="color:var(--astro-code-foreground)">Line</span><span style="color:var(--astro-code-token-punctuation)">:</span><span style="color:var(--astro-code-token-constant)"> 1</span></span></code></pre>
<p>If you want the full details about how the Same Origin Policy (SOP) works, go <a href="https://developer.mozilla.org/en-US/docs/Web/Security/Same-origin_policy">here</a>, but for the purpose of this vulnerability we are interested just in this small part:</p>
<p><img src="/images/2016/09/cross-origin-errors.png" alt="Cross Origin Errors"></p>
<p>So now that we are on the same page on how this <em>should work</em>, let’s bypass the restriction using <a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Using_web_workers">Workers</a>.</p>
<p>Normally, we are not able to create workers on different domains. In fact, any attempt will make the browser angry throwing a security error immediately. Let’s try to create a bing.com Worker from a webpage hosted in cracking.com.ar just to see what happens.</p>
<p><img src="/images/2016/09/security-error.png" alt="security-error"></p>
<p>See? We can’t even create the Worker!</p>
<p>What would happen if we change our own document baseURI (the base href) so it points to bing.com before creating the Worker?</p>
<p><img src="/images/2016/09/security-error-bypassed2.png" alt="Security-error-bypassed"></p>
<p>Wow! It seems to be our lucky day, right? Not really. If we play a bit with the history, location, and base objects, we will find many interesting things. We don’t need luck but just persistence shaking these objects and tons of fruit will fall (watch your head!). Anyway, let’s quickly build a PoC and see if we can leak data from bing.com</p>
<pre class="astro-code css-variables" style="background-color:var(--astro-code-background);color:var(--astro-code-foreground); overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="javascript"><code><span class="line"><span style="color:var(--astro-code-token-keyword)">var</span><span style="color:var(--astro-code-foreground)"> base </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-token-constant)"> document</span><span style="color:var(--astro-code-token-function)">.createElement</span><span style="color:var(--astro-code-foreground)">(</span><span style="color:var(--astro-code-token-string-expression)">"base"</span><span style="color:var(--astro-code-foreground)">);</span></span>
<span class="line"><span style="color:var(--astro-code-token-constant)">base</span><span style="color:var(--astro-code-foreground)">.href </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-token-string-expression)"> "http://www.bing.com"</span><span style="color:var(--astro-code-foreground)">;</span></span>
<span class="line"><span style="color:var(--astro-code-token-constant)">document</span><span style="color:var(--astro-code-token-function)">.</span><span style="color:var(--astro-code-token-constant)">head</span><span style="color:var(--astro-code-token-function)">.appendChild</span><span style="color:var(--astro-code-foreground)">(base);</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">var</span><span style="color:var(--astro-code-foreground)"> worker </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-token-keyword)"> new</span><span style="color:var(--astro-code-token-function)"> Worker</span><span style="color:var(--astro-code-foreground)">(</span><span style="color:var(--astro-code-token-string-expression)">'http://www.bing.com/sa/8_1_2_5126428/HpbHeaderPopup.js'</span><span style="color:var(--astro-code-foreground)">);</span></span>
<span class="line"><span style="color:var(--astro-code-token-constant)">worker</span><span style="color:var(--astro-code-foreground)">.</span><span style="color:var(--astro-code-token-function)">onerror</span><span style="color:var(--astro-code-token-keyword)"> =</span><span style="color:var(--astro-code-token-keyword)"> function</span><span style="color:var(--astro-code-foreground)">(err)</span></span>
<span class="line"><span style="color:var(--astro-code-foreground)">{</span></span>
<span class="line"><span style="color:var(--astro-code-token-function)">	alert</span><span style="color:var(--astro-code-foreground)">(</span><span style="color:var(--astro-code-token-string-expression)">"URL: "</span><span style="color:var(--astro-code-token-keyword)">+</span><span style="color:var(--astro-code-token-constant)"> err</span><span style="color:var(--astro-code-foreground)">.filename </span><span style="color:var(--astro-code-token-keyword)">+</span></span>
<span class="line"><span style="color:var(--astro-code-token-string-expression)">		"\n\nLine: "</span><span style="color:var(--astro-code-token-keyword)"> +</span><span style="color:var(--astro-code-token-constant)"> err</span><span style="color:var(--astro-code-foreground)">.lineno </span><span style="color:var(--astro-code-token-keyword)">+</span></span>
<span class="line"><span style="color:var(--astro-code-token-string-expression)">		"\n\nError: "</span><span style="color:var(--astro-code-token-keyword)"> +</span><span style="color:var(--astro-code-token-constant)"> err</span><span style="color:var(--astro-code-foreground)">.message);</span></span>
<span class="line"><span style="color:var(--astro-code-foreground)">}</span></span></code></pre>
<p><img src="/images/2016/09/errorleakalert.png" alt="Error Leak"></p>
<p>Oh, I know what you are thinking now, bug hunter. You think that “just leaking the name of a member” is no big deal, right? Maybe, but keep in mind that many sites response content customized to the user and if we can leak enough data we might end up guessing tons of things about her. Also, if we find a javascript file on that origin that reads content (like using XMLHttpRequest) we may end up abusing it and accessing more stuff. In any case, let’s say that the leaked error “<em>undefined sj_ic</em>” is not enough for us and we want more. That’s great!</p>
<p>We will bypass that error so the script at Bing keeps running. This time no changes to the baseUri are needed but we must include the script via importScripts inside the Worker, and even if errors will still leak, the imported script will execute in our own context (origin).  This has a pro and a con. The con is that if we find a script that uses the XMLHttpRequest, we won’t be able to abuse of it because it will be running in our own domain. The pro is that we will still be able to read errors and add code before/after them, letting us bypass uninteresting stuff until we arrive to an error that is interesting. In other words, we will create code that suppresses errors so the script keeps running, until we arrive to important pieces of data.</p>
<p>For example, let’s create an empty function called just like the leaked error “sj_ic” before importing the script. Bing will not fire <em>that error</em> anymore because sj_ic <strong>is</strong> defined now.</p>
<pre class="astro-code css-variables" style="background-color:var(--astro-code-background);color:var(--astro-code-foreground); overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="javascript"><code><span class="line"><span style="color:var(--astro-code-token-comment)">// Main</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">var</span><span style="color:var(--astro-code-foreground)"> worker </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-token-keyword)"> new</span><span style="color:var(--astro-code-token-function)"> Worker</span><span style="color:var(--astro-code-foreground)">(</span><span style="color:var(--astro-code-token-string-expression)">'workerimporterror.js'</span><span style="color:var(--astro-code-foreground)">);</span></span>
<span class="line"><span style="color:var(--astro-code-token-constant)">worker</span><span style="color:var(--astro-code-foreground)">.</span><span style="color:var(--astro-code-token-function)">onerror</span><span style="color:var(--astro-code-token-keyword)"> =</span><span style="color:var(--astro-code-token-keyword)"> function</span><span style="color:var(--astro-code-foreground)">(err)</span></span>
<span class="line"><span style="color:var(--astro-code-foreground)">{</span></span>
<span class="line"><span style="color:var(--astro-code-token-function)">	alert</span><span style="color:var(--astro-code-foreground)">(</span><span style="color:var(--astro-code-token-string-expression)">"URL: "</span><span style="color:var(--astro-code-token-keyword)">+</span><span style="color:var(--astro-code-token-constant)"> err</span><span style="color:var(--astro-code-foreground)">.filename </span><span style="color:var(--astro-code-token-keyword)">+</span></span>
<span class="line"><span style="color:var(--astro-code-token-string-expression)">		"\n\nLine: "</span><span style="color:var(--astro-code-token-keyword)"> +</span><span style="color:var(--astro-code-token-constant)"> err</span><span style="color:var(--astro-code-foreground)">.lineno </span><span style="color:var(--astro-code-token-keyword)">+</span></span>
<span class="line"><span style="color:var(--astro-code-token-string-expression)">		"\n\nError: "</span><span style="color:var(--astro-code-token-keyword)"> +</span><span style="color:var(--astro-code-token-constant)"> err</span><span style="color:var(--astro-code-foreground)">.message);</span></span>
<span class="line"><span style="color:var(--astro-code-foreground)">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-token-comment)">//---- workerimporterror.js ----</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">function</span><span style="color:var(--astro-code-token-function)"> sj_ic</span><span style="color:var(--astro-code-foreground)">(){} </span><span style="color:var(--astro-code-token-comment)">// Empty to suppress the first error and read the next one.</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-token-function)">importScripts</span><span style="color:var(--astro-code-foreground)">(</span><span style="color:var(--astro-code-token-string-expression)">"http://www.bing.com/sa/8_1_2_5126428/HpbHeaderPopup.js"</span><span style="color:var(--astro-code-foreground)">);</span></span></code></pre>
<p>The new leaked error: “_H is undefined”.</p>
<p><img src="/images/2016/09/bing-data-02.png" alt="bing-data-02"></p>
<p>Of course an attacker will keep feeding the external script until she gets the information she wants, but we are just bug-hunters having fun, so let’s stop it here! :D</p>
<p><strong>Update:</strong> this bug has been patched on <a href="https://technet.microsoft.com/en-us/library/security/MS16-145">MS16-145</a>, apparently labeled as CVE-2016-7281.</p>
<p><a href="https://goo.gl/rflIrM">Download the Files</a></p>
<p>Have a great day!</p>
<p><a href="https://twitter.com/magicmac2000">Manuel</a></p>
<p>Update [2016-09-28]: thanks to <a href="https://twitter.com/garethheyes">Gareth Heyes</a> for pointing me out a <a href="https://twitter.com/magicmac2000/status/780817066957869061">confusion with a previous PoC</a> presented here. I’ve corrected it now and hopefully it’s clearer. Thanks Gareth!</p> <div class="pagination"> <div class="pagination__title"> <span class="pagination__title-h">Read other posts</span> <hr> </div> <div class="pagination__buttons">  <a href="/blog/detecting-apps-mimetype-malware/" class="button inline prev">
&lt; [Detecting analysts before installing the malware (IE)]
</a> <span>::</span> <a href="/blog/on-patching-security-bugs/" class="button inline next">
[On Patching Security Bugs] &gt;
</a> </div> </div>  </div> </article> <script type="module">document.addEventListener("DOMContentLoaded",()=>{document.querySelectorAll("pre.astro-code").forEach(t=>{const n=document.createElement("div");n.className="highlight",t.parentNode?.insertBefore(n,t),n.appendChild(t);const a=t.getAttribute("data-language")||"text",o=document.createElement("div");if(o.className="code-title",o.textContent=a,navigator.clipboard){const e=document.createElement("button");e.className="copy-button",e.textContent="Copy",e.addEventListener("click",async()=>{const c=t.textContent||"";try{await navigator.clipboard.writeText(c),e.textContent="Copied",setTimeout(()=>{e.textContent="Copy"},1e3)}catch(r){console.error("Failed to copy:",r)}}),o.appendChild(e)}n.insertBefore(o,t)})});</script>  <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>  </main> <footer class="footer"> <div class="footer__inner"> <div class="copyright"> <span>© 2026 MagicMac Labs</span> </div> </div> </footer> </div> <script type="module">(()=>{const s=document.querySelector(".container"),o=document.querySelectorAll(".menu");document.body.addEventListener("click",()=>{o.forEach(e=>{e.classList.contains("open")&&e.classList.remove("open")})}),window.addEventListener("resize",()=>{o.forEach(e=>{e.classList.remove("open")})}),o.forEach(e=>{const i=e.querySelector(".menu__trigger"),t=e.querySelector(".menu__dropdown");i&&t&&(i.addEventListener("click",n=>{n.stopPropagation(),e.classList.contains("open")?e.classList.remove("open"):(o.forEach(c=>c.classList.remove("open")),e.classList.add("open")),s&&t.getBoundingClientRect().right>s.getBoundingClientRect().right&&(t.style.left="auto",t.style.right="0")}),t.addEventListener("click",n=>n.stopPropagation()))})})();</script> </body> </html> 