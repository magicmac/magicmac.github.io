<!DOCTYPE html><html lang="en"> <head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><link rel="alternate icon" type="image/x-icon" href="/favicon.ico"><meta name="generator" content="Astro v5.16.6"><title>Spoofing the address bar and the SmartScreen/Malware Warning (Edge)</title><meta name="description" content><link rel="canonical" href="https://www.brokenbrowser.com/blog/spoof-addressbar-malware/"><meta property="og:title" content="Spoofing the address bar and the SmartScreen/Malware Warning (Edge)"><meta property="og:description" content><meta property="og:type" content="website"><meta property="og:url" content="https://www.brokenbrowser.com/blog/spoof-addressbar-malware/"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:title" content="Spoofing the address bar and the SmartScreen/Malware Warning (Edge)"><meta name="twitter:description" content><link rel="sitemap" href="/sitemap-index.xml"><link rel="alternate" type="application/rss+xml" title="RSS" href="/rss.xml"><link rel="stylesheet" href="/_astro/_slug_.D8CnJWvD.css"></head> <body> <div class="container center"> <header class="header"> <div class="header__inner"> <div class="header__logo"> <a href="/"> <div class="logo">
MagicMac Labs
</div> </a> </div> <ul class="menu menu--mobile"> <li class="menu__trigger">Menu ▾</li> <li> <ul class="menu__dropdown"> <!--<li><a href={`${base}`}>Home</a></li>--> <li><a href="/browser-workshop/">Browser Workshop</a></li> <li><a href="/musings/">Musings</a></li> <li><a href="/about/">About</a></li> </ul> </li> </ul> </div> <nav class="navigation-menu"> <ul class="navigation-menu__inner menu--desktop"> <!--<li><a href={`${base}`}>Home</a></li>--> <li><a href="/browser-workshop/">Browser Workshop</a></li> <li><a href="/musings/">Musings</a></li> <li><a href="/about/">About</a></li> </ul> </nav> </header> <main class="content">  <article> <h1 class="post-title">Spoofing the address bar and the SmartScreen/Malware Warning (Edge)</h1> <div class="post-meta"> <time> <time datetime="2016-12-07T00:00:00.000Z"> 2016-12-07 </time> </time> <span class="post-category"> :: browser-workshop</span>  </div>  <div class="post-content">  <p><strong>Update</strong>: this bug was patched on 2017-03-14 but we found a bypass the same day. Here it is: <a href="../bypass-the-patch-to-keep-spoofing-the-address-bar-with-the-malware-warning/">Bypassing the patch to continue spoofing the address bar and the Malware Warning</a>.</p>
<p>Over the last few months, we’ve seen a proliferation of these tech-support scams where users end up “locked” in their browsers with horrible red-screens and messages like “<em>your computer may be at risk</em>”. This is <a href="https://blog.malwarebytes.com/threat-analysis/2014/08/beware-of-us-based-tech-support-scams/">not new</a> of course, but scammers are using <a href="https://twitter.com/douglasmun/status/803964946044157952">more</a> tricks to fool their victims.</p>
<p><img src="/images/2016/12/01-scam-tech-support.png" alt="01-scam-tech-support"></p>
<p>They render red warnings or <a href="https://en.wikipedia.org/wiki/Blue_Screen_of_Death">BSODs</a> with fake messages and sometimes they even throw blocking alerts to prevent users from going away. When a user closes the alert box a new one appears, ad infinitum. In fact, the Chrome version that Jérôme Segura sent me was literally freezing the browser by using a <a href="https://blog.malwarebytes.com/cybercrime/social-engineering-cybercrime/2016/11/tech-support-scammers-abuse-bug-in-html5-feature-to-freeze-computers/">continuous history.pushState trick</a>. Bastards.</p>
<p>Jérôme’s sample lead me to read more, and I ended up learning about the <a href="https://blogs.windows.com/msedgedev/2015/12/16/smartscreen-drive-by-improvements/">SmartScreen on Edge</a> with its protection against drive-by attacks. It’s cool to see it blocking blacklisted URLs. The <a href="http://demo.smartscreen.msft.net/">SmartScreen Demo</a> site is full of samples, and I’ve chosen the <a href="http://demo.smartscreen.msft.net/other/malware.html">malware page</a>.</p>
<p><img src="/images/2016/12/02-smartscreen-demo-pages.png" alt="Smartscreen Demo Pages"></p>
<p>It was correctly blocked. I know that other browsers (at least IE and Chrome) also handle these things, but I was happy to see it working on Edge. However, I was curious about where this warning page was really coming from, because the address bar points to a URL but the content of the page is obviously not coming from that <strong>blocked</strong> site. Is this an internal resource? Let’s find out! Press F12 on Edge to open DevTools, and type “location” in the console.</p>
<p><img src="/images/2016/12/03-f12-realurl.png" alt="DevTools Real URL"></p>
<p>Wow! It seems the real URL is not the one that appears in the address bar. DevTools is telling us that we are located (location.href) in ms-appx-web://microsoft.microsoftedge/assets/errorpages/PhishSiteEdge.htm and the visible URL in the address bar comes from the hash? Also, it looks like this internal page is getting some stuff from the location.search property.</p>
<p>This seems interesting. Can we write any URL in the address bar just by setting an arbitrary string after the hash? Where is this htm file coming from? The protocols <strong>ms-appx:</strong> and <strong>ms-appx-web:</strong> are used in modern Windows Apps to load their internal resources. Let’s quickly go to the Microsoft Edge folder to see if this file exists. Open Task Manager, details, right click on Microsoft Edge and select properties.</p>
<p><img src="/images/2016/12/04-edge-location.png" alt="Edge Path"></p>
<p>Microsoft Edge is located in C:\Windows\SystemApps\Microsoft.MicrosoftEdge_8wekyb3d8bbwe\ and the error pages (as shown in DevTools above) inside the \Assets\ErrorPages folder.</p>
<p><img src="/images/2016/12/05-phishsite.png" alt="PhishSite"></p>
<p>There are many files to play with, let’s try to load them from Edge using the full ms-appx-web URL, just like this: ms-appx-web://microsoft.microsoftedge/assets/errorpages/PhishSiteEdge.htm</p>
<p>Damn it! It goes to my default search engine.</p>
<p><img src="/images/2016/12/06-no-load-in-address-bar.png" alt="URL not loading"></p>
<p>Let’s try another htm file from that folder, the first one of the list is <strong>acr_error.htm</strong>. ms-appx-web://microsoft.microsoftedge/assets/errorpages/acr_error.htm</p>
<p>Yes! This one loads. It seems to me that Edge is selectively allowing us to load some pages, but not others. What about the next one, BlockSite.htm? ms-appx-web://microsoft.microsoftedge/assets/errorpages/BlockSite.htm</p>
<p>Negative. In fact, if we create a webpage with a link pointing to that URL, clicking on it does absolutely nothing. No loading. Same with scripting. Silence. We will try using window.open (why? <a href="../detecting-local-files-to-evade-analysts/">described here in the final thoughts</a>) which comes handy in these cases, because if there is a problem the browser will actually throw an error. What do we prefer, a browser that remains silent when it refuses to do something, or a browser that at least complains and throws an error?</p>
<pre class="astro-code css-variables" style="background-color:var(--astro-code-background);color:var(--astro-code-foreground); overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="javascript"><code><span class="line"><span style="color:var(--astro-code-token-constant)">window</span><span style="color:var(--astro-code-token-function)">.open</span><span style="color:var(--astro-code-foreground)">(</span><span style="color:var(--astro-code-token-string-expression)">"ms-appx-web://microsoft.microsoftedge/assets/errorpages/BlockSite.htm"</span><span style="color:var(--astro-code-foreground)">);</span></span></code></pre>
<p><img src="/images/2016/12/07-access-denied.png" alt="Access Denied"></p>
<p>Now we get an access denied!  One thing is to have the browser telling us explicitly that there’s a problem (access denied) and a very different thing is a browser that refuses to load a resource. It’s matter of speed: we can now use a try/catch to quickly retry, on the other hand, using a location.href loads nothing which makes us depend on a timeout or an event (onload/onerror) to see what happened. If we wanted to try a million URLs (think fuzzing) it would have been more convenient a try/catch than using handlers/onload.</p>
<p>After several manual tries using window.open we come to the conclusion that Edge happily loads pages like <strong>acr_error.htm</strong> but will totally refuse to load <strong>BlockSite.htm</strong>. In fact, changing any character from BlockSite.htm loads a non-existent page but <strong>throws no errors</strong>. This means that somewhere in the deep ocean of Edge, there’s binary code that compares our URL with “BlockSite.htm”.</p>
<p>To be clear, this URL throws ACCESS_DENIED
ms-appx-web://microsoft.microsoftedge/assets/errorpages/BlockSite.htm</p>
<p>But changing any character (the “B” of BlockSite in this case) throws no errors at all.
ms-appx-web://microsoft.microsoftedge/assets/errorpages/<strong>C</strong>lockSite.htm</p>
<p>We know that altering a simple character fools Edge, but the page is not loaded because it does not exist :). How can we change a character making sure the URL is still valid? Encoding! Let’s try to replace the dot from BlockSite.htm with its ASCII code, 2E, just like this: BlockSite%2ehtm</p>
<pre class="astro-code css-variables" style="background-color:var(--astro-code-background);color:var(--astro-code-foreground); overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="javascript"><code><span class="line"><span style="color:var(--astro-code-token-constant)">window</span><span style="color:var(--astro-code-token-function)">.open</span><span style="color:var(--astro-code-foreground)">(</span><span style="color:var(--astro-code-token-string-expression)">"ms-appx-web://microsoft.microsoftedge/assets/errorpages/BlockSite%2ehtm"</span><span style="color:var(--astro-code-foreground)">);</span></span></code></pre>
<p>Yes! Edge allowed us to load the resource now, lets append a hash and URL like this: <code>#http://www.facebook.com</code></p>
<pre class="astro-code css-variables" style="background-color:var(--astro-code-background);color:var(--astro-code-foreground); overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="javascript"><code><span class="line"><span style="color:var(--astro-code-token-constant)">window</span><span style="color:var(--astro-code-token-function)">.open</span><span style="color:var(--astro-code-foreground)">(</span><span style="color:var(--astro-code-token-string-expression)">"ms-appx-web://microsoft.microsoftedge/assets/errorpages/BlockSite%2ehtm"</span><span style="color:var(--astro-code-token-keyword)">+</span></span>
<span class="line"><span style="color:var(--astro-code-token-string-expression)">"#http://www.facebook.com"</span><span style="color:var(--astro-code-foreground)">);</span></span></code></pre>
<p><img src="/images/2016/12/08-fb.png" alt="Facebook Spoofed"></p>
<p>Pause. Enjoy. Continue. So we can now open a very ugly webpage with a spoofed URL. But BlockSite.htm is getting a couple of arguments (BlockedDomain and Host) from the location.search. Let’s use them! (Note for the XSS Master <a href="https://twitter.com/garethheyes">Gareth</a>: can we try something better here?)</p>
<pre class="astro-code css-variables" style="background-color:var(--astro-code-background);color:var(--astro-code-foreground); overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="javascript"><code><span class="line"><span style="color:var(--astro-code-token-constant)">window</span><span style="color:var(--astro-code-token-function)">.open</span><span style="color:var(--astro-code-foreground)">(</span><span style="color:var(--astro-code-token-string-expression)">"ms-appx-web://microsoft.microsoftedge/assets/errorpages/BlockSite%2ehtm?"</span><span style="color:var(--astro-code-token-keyword)">+</span></span>
<span class="line"><span style="color:var(--astro-code-token-string-expression)">"BlockedDomain=facebook.com&#x26;Host=Technical Support Really Super Legit CALL NOW\:"</span><span style="color:var(--astro-code-token-keyword)">+</span></span>
<span class="line"><span style="color:var(--astro-code-token-string-expression)">"800-111-2222#http://www.facebook.com"</span><span style="color:var(--astro-code-foreground)">);</span></span></code></pre>
<p><img src="/images/2016/12/09-fb.png" alt="Facebook Scam"></p>
<h3 id="patched-on-2017-03-14"><a href="https://technet.microsoft.com/library/security/MS17-006">Patched on 2017-03-14</a></h3>
<p>As a bonus, when we place a telephone-like number, a link is automatically created so the user can call us with a single click. Very convenient for these scammers.</p>
<p>Bug hunter, I will stop here but IMO there are tons of things to research. Are you curious about what other things these internal pages do? We can load them all without restrictions now. For example, needie.html is worth checking (if we can bypass more stuff) because it has the power to run Internet Explorer. It didn’t work for me and it’s clear that it opens a different Edge process which deserves even more research. If you want to see it in action, <a href="https://redmondts.microsoft.com/">try opening this page on Edge</a> and see how it works.</p>
<p>Finally, if you are curious about how the string comparison happens and why it fails, <a href="http://pastebin.com/U3GqV3SV">load EdgeHtml.dll in IDA free</a> and analyze the function <strong>CURLBlock::s_IsBlockPageUrl</strong>. If you prefer live debugging, a breakpoint in <strong>EdgeHtml!CURLBlock::s_IsBlockPageUrl</strong> will make it.</p>
<p>Have a nice day!</p>
<p><a href="https://twitter.com/magicmac2000">Manuel</a></p> <div class="pagination"> <div class="pagination__title"> <span class="pagination__title-h">Read other posts</span> <hr> </div> <div class="pagination__buttons">  <a href="/blog/abusing-of-protocols/" class="button inline prev">
&lt; [Abusing of Protocols to Load Local Files, bypass the HTML5 Sandbox and Open Popups (Edge)]
</a> <span>::</span> <a href="/blog/uxss-edge-domainless-world/" class="button inline next">
[SOP bypass / UXSS - Adventures in a Domainless World (Edge)] &gt;
</a> </div> </div>  </div> </article> <script type="module">document.addEventListener("DOMContentLoaded",()=>{document.querySelectorAll("pre.astro-code").forEach(t=>{const n=document.createElement("div");n.className="highlight",t.parentNode?.insertBefore(n,t),n.appendChild(t);const a=t.getAttribute("data-language")||"text",o=document.createElement("div");if(o.className="code-title",o.textContent=a,navigator.clipboard){const e=document.createElement("button");e.className="copy-button",e.textContent="Copy",e.addEventListener("click",async()=>{const c=t.textContent||"";try{await navigator.clipboard.writeText(c),e.textContent="Copied",setTimeout(()=>{e.textContent="Copy"},1e3)}catch(r){console.error("Failed to copy:",r)}}),o.appendChild(e)}n.insertBefore(o,t)})});</script>  <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>  </main> <footer class="footer"> <div class="footer__inner"> <div class="copyright"> <span>© 2026 MagicMac Labs</span> </div> </div> </footer> </div> <script type="module">(()=>{const s=document.querySelector(".container"),o=document.querySelectorAll(".menu");document.body.addEventListener("click",()=>{o.forEach(e=>{e.classList.contains("open")&&e.classList.remove("open")})}),window.addEventListener("resize",()=>{o.forEach(e=>{e.classList.remove("open")})}),o.forEach(e=>{const i=e.querySelector(".menu__trigger"),t=e.querySelector(".menu__dropdown");i&&t&&(i.addEventListener("click",n=>{n.stopPropagation(),e.classList.contains("open")?e.classList.remove("open"):(o.forEach(c=>c.classList.remove("open")),e.classList.add("open")),s&&t.getBoundingClientRect().right>s.getBoundingClientRect().right&&(t.style.left="auto",t.style.right="0")}),t.addEventListener("click",n=>n.stopPropagation()))})})();</script> </body> </html> 